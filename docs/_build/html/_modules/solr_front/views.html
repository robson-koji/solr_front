

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>solr_front.views &mdash; Documentação Solr Font 0.1</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Índice"
              href="../../genindex.html"/>
        <link rel="search" title="Pesquisar" href="../../search.html"/>
    <link rel="top" title="Documentação Solr Font 0.1" href="../../index.html"/>
        <link rel="up" title="Código do módulo" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Solr Font
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Introdução</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/util.html">Utilização</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/install.html">Instalação</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/config.html">Configuração</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra/infra.html">Infraestrutura</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/coll_rela.html">Collections relacionadas</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Solr Font</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Código do módulo</a> &raquo;</li>
        
      <li>solr_front.views</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Código fonte de solr_front.views</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span><span class="p">,</span> <span class="n">HttpResponseServerError</span>
<span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="k">import</span> <span class="n">FormView</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">,</span> <span class="n">UpdateView</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span><span class="p">,</span> <span class="n">render_to_response</span>
<span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="k">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="k">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="k">import</span> <span class="n">View</span><span class="p">,</span> <span class="n">TemplateView</span>
<span class="kn">from</span> <span class="nn">django.views.generic.base</span> <span class="k">import</span> <span class="n">RedirectView</span>
<span class="kn">from</span> <span class="nn">django.views.generic.detail</span> <span class="k">import</span> <span class="n">DetailView</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="k">import</span> <span class="n">get_template</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="k">import</span> <span class="n">TemplateDoesNotExist</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="k">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">Http404</span>

<span class="kn">from</span> <span class="nn">xml.etree</span> <span class="k">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">ET</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">urllib</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">textwrap</span><span class="o">,</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="c1"># from conf import *</span>

<span class="kn">from</span> <span class="nn">solr_front.exceptions</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">solr_front</span> <span class="k">import</span> <span class="n">settings_sf</span>
<span class="kn">from</span> <span class="nn">solr_front.models</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">solr_front.forms</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">solr_front</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="k">import</span> <span class="n">login_required</span>

<span class="k">if</span> <span class="n">settings_sf</span><span class="o">.</span><span class="n">USE_CELERY</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">solr_front.tasks</span> <span class="k">import</span> <span class="n">update_atomico</span> <span class="k">as</span> <span class="n">update_atomico_celery</span>
    <span class="kn">from</span> <span class="nn">solr_front.tasks</span> <span class="k">import</span> <span class="n">makeCsv</span> <span class="k">as</span> <span class="n">makeCsv_celery</span>
    <span class="kn">from</span> <span class="nn">solr_front.tasks</span> <span class="k">import</span> <span class="n">makeData</span> <span class="k">as</span> <span class="n">makeData_celery</span>
    <span class="kn">from</span> <span class="nn">celery.result</span> <span class="k">import</span> <span class="n">AsyncResult</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="LoginRequiredMixin"><a class="viewcode-back" href="../../code/views.html#solr_front.views.LoginRequiredMixin">[documentos]</a><span class="k">class</span> <span class="nc">LoginRequiredMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="LoginRequiredMixin.as_view"><a class="viewcode-back" href="../../code/views.html#solr_front.views.LoginRequiredMixin.as_view">[documentos]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">initkwargs</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="o">**</span><span class="n">initkwargs</span><span class="p">)</span>
        <span class="c1"># if not settings.DEBUG:</span>
        <span class="c1">#     return login_required(view)</span>
        <span class="k">return</span> <span class="n">view</span></div></div>


<div class="viewcode-block" id="find_template"><a class="viewcode-back" href="../../code/views.html#solr_front.views.find_template">[documentos]</a><span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    @params: template - template name. May include a folder with the name,</span>
<span class="sd">    if the template is not at the root folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;solr_front/custom/&#39;</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">template</span>
        <span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TemplateDoesNotExist</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;solr_front/custom/&#39;</span> <span class="o">+</span> <span class="n">template</span>
            <span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">TemplateDoesNotExist</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;solr_front/sample/&#39;</span> <span class="o">+</span> <span class="n">template</span>
            <span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">template_name</span></div>


<div class="viewcode-block" id="AjaxCeleryStatusView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AjaxCeleryStatusView">[documentos]</a><span class="k">class</span> <span class="nc">AjaxCeleryStatusView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<div class="viewcode-block" id="AjaxCeleryStatusView.dispatch"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AjaxCeleryStatusView.dispatch">[documentos]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task_id</span><span class="p">:</span>
            <span class="n">async_result</span> <span class="o">=</span> <span class="n">AsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">async_result</span><span class="o">.</span><span class="n">failed</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">async_result</span><span class="o">.</span><span class="n">traceback</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">async_result</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">async_result</span><span class="o">.</span><span class="n">state</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">async_result</span><span class="o">.</span><span class="n">state</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;undefined&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;enviar id!&#39;</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="AjaxVerticeEditFieldView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AjaxVerticeEditFieldView">[documentos]</a><span class="k">class</span> <span class="nc">AjaxVerticeEditFieldView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recebe os requests ajax para editar o campo de um vertice.</span>
<span class="sd">    O pai (EntryPointView) trata o request, recupera resultados no Solr e retorna para o frontend.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AjaxVerticeEditFieldView.dispatch"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AjaxVerticeEditFieldView.dispatch">[documentos]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Trying access to a not known collection.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s2">&quot;Collection does not exist&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span> <span class="o">=</span> <span class="n">NavigateCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">get_vertice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span>

        <span class="c1"># recupera field enviado pelo plugin</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span>
        <span class="c1"># recupera label do field enviado pelo plugin</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">update_vertice_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="n">navigation_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">get_navigation_tree</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">change</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;vertice&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">,</span> <span class="s1">&#39;navigation_tree&#39;</span><span class="p">:</span> <span class="n">navigation_tree</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;Erro ao atualizar &#39;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;, tente novamente&#39;</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="NavigateCollection"><a class="viewcode-back" href="../../code/views.html#solr_front.views.NavigateCollection">[documentos]</a><span class="k">class</span> <span class="nc">NavigateCollection</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manipula a montagem de um caminho no grapho.</span>
<span class="sd">    Esta view eh acessada qdo o usuario solicita a visualizacao dos subconjuntos</span>
<span class="sd">    de dados de uma segunda collection</span>
<span class="sd">    Armazena na sessao.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertice_inicial</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resolver_match</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;navigation&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertice_inicial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;navigation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

<div class="viewcode-block" id="NavigateCollection.get_navigation_tree"><a class="viewcode-back" href="../../code/views.html#solr_front.views.NavigateCollection.get_navigation_tree">[documentos]</a>    <span class="k">def</span> <span class="nf">get_navigation_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retorna arvore de navegacao &quot;&quot;&quot;</span>

        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;navigation&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">navigation_tree</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">get_rec_navigate_fieds</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">):</span>
            <span class="n">my_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">],</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent_id</span><span class="p">,</span>
                       <span class="s1">&#39;hash_querybuilder&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;hash_querybuilder&#39;</span><span class="p">]}</span>
            <span class="n">navigation_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_dict</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">vertice</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
                <span class="c1"># analisa recursivamente os vertices da navegacao.</span>
                <span class="n">get_rec_navigate_fieds</span><span class="p">(</span><span class="n">vertice</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="c1"># Pega na sessao o objeto navigation.</span>
        <span class="n">navigation</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;navigation&#39;</span><span class="p">]</span>

        <span class="c1"># inicia captura dos fields dos vertices contidos na navegacao.</span>
        <span class="n">get_rec_navigate_fieds</span><span class="p">(</span><span class="n">navigation</span><span class="p">[</span><span class="n">navigation</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">navigation</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">navigation_tree</span></div>

<div class="viewcode-block" id="NavigateCollection.remove_tree"><a class="viewcode-back" href="../../code/views.html#solr_front.views.NavigateCollection.remove_tree">[documentos]</a>    <span class="k">def</span> <span class="nf">remove_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">vertices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">id</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_tree</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">],</span> <span class="nb">id</span><span class="p">)</span>
                <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">:</span>
                <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vertices</span></div>

<div class="viewcode-block" id="NavigateCollection.count_vertices"><a class="viewcode-back" href="../../code/views.html#solr_front.views.NavigateCollection.count_vertices">[documentos]</a>    <span class="k">def</span> <span class="nf">count_vertices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conta a quantidade de vertices recursivamente &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span><span class="p">)</span></div>

<div class="viewcode-block" id="NavigateCollection.add_vertice"><a class="viewcode-back" href="../../code/views.html#solr_front.views.NavigateCollection.add_vertice">[documentos]</a>    <span class="k">def</span> <span class="nf">add_vertice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">pai_id</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">,</span> <span class="n">hash_querybuilder</span><span class="p">,</span> <span class="n">initial_search</span><span class="p">,</span> <span class="n">pedido</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Se existe grapho recupera o vertice atual e adiciona um filho.</span>
<span class="sd">        Se nao, cria vertice.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print &#39;\n\n add_vertice 1&#39;</span>
        <span class="c1"># import pdb; pdb.set_trace()</span>

        <span class="k">def</span> <span class="nf">set_vertice</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">hash_id</span><span class="p">,</span> <span class="n">pai_id</span><span class="p">,</span> <span class="n">pedido</span><span class="p">):</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="n">collection</span><span class="p">,</span>
                    <span class="s1">&#39;pedido&#39;</span><span class="p">:</span> <span class="n">pedido</span> <span class="k">if</span> <span class="n">pedido</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;body_json&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">collection</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="n">collection</span><span class="p">,</span>
                            <span class="s1">&#39;selected_facets_col1&#39;</span><span class="p">:</span> <span class="n">selected_facets</span><span class="p">[</span><span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;selected_facets_col2&#39;</span><span class="p">:</span> <span class="p">{},</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">hash_id</span><span class="p">,</span>
                    <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">pai_id</span><span class="p">,</span>
                    <span class="s1">&#39;hash_querybuilder&#39;</span><span class="p">:</span> <span class="n">hash_querybuilder</span><span class="p">,</span>
                    <span class="s1">&#39;tree&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;initial_search&#39;</span><span class="p">:</span> <span class="n">initial_search</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">u&#39;Descrição&#39;</span>
                    <span class="p">}</span>

        <span class="k">if</span> <span class="n">pai_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vertice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vertice</span><span class="p">(</span><span class="n">pai_id</span><span class="p">)</span>
            <span class="n">hash_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_vertices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice_inicial</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">])</span>
            <span class="n">vertice_filho</span> <span class="o">=</span> <span class="n">set_vertice</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">hash_id</span><span class="p">,</span> <span class="n">pai_id</span><span class="p">,</span> <span class="n">pedido</span><span class="p">)</span>
            <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertice_filho</span><span class="p">)</span>

            <span class="c1"># print &#39;\n\n add_vertice 2&#39;</span>
            <span class="c1"># import pdb; pdb.set_trace()</span>

            <span class="k">return</span> <span class="n">hash_id</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If master parent, create a &quot;random&quot; id</span>
            <span class="n">random_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;navigation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;navigation&#39;</span><span class="p">][</span><span class="n">collection</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_vertice</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">random_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pedido</span><span class="p">)</span>
            <span class="c1"># import pdb; pdb.set_trace()</span>
            <span class="k">return</span> <span class="n">random_id</span>  <span class="c1"># Nova navegacao.</span></div>

<div class="viewcode-block" id="NavigateCollection.get_vertice"><a class="viewcode-back" href="../../code/views.html#solr_front.views.NavigateCollection.get_vertice">[documentos]</a>    <span class="k">def</span> <span class="nf">get_vertice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Localiza recursivamente um vertice especifico &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;navigation&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_rec_vertice</span><span class="p">(</span><span class="n">lista</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">vertice</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">vertice</span>
                <span class="k">if</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
                    <span class="n">rec_vertice</span> <span class="o">=</span> <span class="n">get_rec_vertice</span><span class="p">(</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">],</span> <span class="nb">id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rec_vertice</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">rec_vertice</span>

        <span class="n">vertice</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;navigation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
            <span class="n">vertice</span> <span class="o">=</span> <span class="n">get_rec_vertice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice_inicial</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">],</span> <span class="nb">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vertice</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vertice</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;navigation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span></div>

<div class="viewcode-block" id="NavigateCollection.update_vertice"><a class="viewcode-back" href="../../code/views.html#solr_front.views.NavigateCollection.update_vertice">[documentos]</a>    <span class="k">def</span> <span class="nf">update_vertice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body_json</span><span class="p">,</span> <span class="n">hash_querybuilder</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">,</span> <span class="n">initial_search</span><span class="p">):</span>
        <span class="n">vertice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vertice</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;body_json&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;body_json&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="c1"># Se parar aqui eh pq tem erro de navegacao.</span>
            <span class="n">alerta</span> <span class="o">=</span> <span class="s2">&quot;Erro de navegação!&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;solr_front/muda_collection.html&#39;</span><span class="p">,</span>
                              <span class="p">{</span><span class="s1">&#39;alerta&#39;</span><span class="p">:</span> <span class="n">alerta</span><span class="p">,</span> <span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GenericLoggerException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>

        <span class="c1"># print &#39;\n\n update_vertice&#39;</span>
        <span class="c1"># import pdb; pdb.set_trace()</span>

        <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;body_json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_json</span>
        <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;hash_querybuilder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_querybuilder</span>
        <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;fq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fq</span>
        <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;selected_facets_col1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_facets</span><span class="p">[</span><span class="s1">&#39;se_selected_facets&#39;</span><span class="p">]</span>
        <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;initial_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_search</span></div>

<div class="viewcode-block" id="NavigateCollection.remove_vertice"><a class="viewcode-back" href="../../code/views.html#solr_front.views.NavigateCollection.remove_vertice">[documentos]</a>    <span class="k">def</span> <span class="nf">remove_vertice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;navigation&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;navigation&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            acertar a recursividade. estah excluindo somente filho do primeiro nivel.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">navigation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;navigation&#39;</span><span class="p">]</span>

            <span class="c1"># converte navigation em lista</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">navigation</span><span class="p">[</span><span class="n">navigation</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;navigation&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">navigation</span><span class="p">[</span><span class="n">navigation</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
                <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_tree</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

            <span class="n">navigation</span><span class="p">[</span><span class="n">navigation</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertices</span></div>

<div class="viewcode-block" id="NavigateCollection.update_vertice_field"><a class="viewcode-back" href="../../code/views.html#solr_front.views.NavigateCollection.update_vertice_field">[documentos]</a>    <span class="k">def</span> <span class="nf">update_vertice_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">vertice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vertice</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;body_json&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;body_json&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="c1"># Se parar aqui eh pq tem erro de navegacao.</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">vertice</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>


<span class="c1">###################</span>
<span class="c1">### View - SOLR ###</span>
<span class="c1">###################</span>


<div class="viewcode-block" id="StreamingExpressions"><a class="viewcode-back" href="../../code/views.html#solr_front.views.StreamingExpressions">[documentos]</a><span class="k">class</span> <span class="nc">StreamingExpressions</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Esta classe monta Streaming Expressions somente. Ela nao executa requests</span>
<span class="sd">    no Solr. Quem faz isso eh a classe SolrQueries.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">solr_queries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recupera as configuracoes do grapho do arquivo conf.py e inicializa as</span>
<span class="sd">        variaveis que serao utilizadas para montar as streaming expressions do Solr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">GRAPH</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">EDGES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span> <span class="o">=</span> <span class="n">solr_queries</span>
        <span class="c1"># import pdb; pdb.set_trace()</span>

<div class="viewcode-block" id="StreamingExpressions.get_search"><a class="viewcode-back" href="../../code/views.html#solr_front.views.StreamingExpressions.get_search">[documentos]</a>    <span class="k">def</span> <span class="nf">get_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monta a expressao de search para um vertice</span>
<span class="sd">        Por ora usando para o vertice raiz na exportacao de dados.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selected_facets</span> <span class="o">=</span> <span class="n">selected_facets</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;*&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>

        <span class="c1"># Limpando sujeiras no mecanismo de facets.</span>
        <span class="c1"># Juntar todos os fqs na funcao do solr_queries.</span>
        <span class="c1"># if not selected_facets and not fq:</span>
        <span class="c1">#     fq2 = &#39;&#39;</span>
        <span class="c1"># if fq:</span>
        <span class="c1">#     fq = &#39;,fq=&#39; + fq</span>
        <span class="c1"># fq2 = fq + &#39;, &#39; + selected_facets</span>

        <span class="n">search_se</span> <span class="o">=</span> <span class="s1">&#39;search(</span><span class="si">%s</span><span class="s1">, qt=&quot;/export&quot;, q=*:*, fl=&quot;id&quot;, sort=&quot;id asc&quot;, </span><span class="si">%s</span><span class="s1">)&#39;</span>
        <span class="n">search_se</span> <span class="o">=</span> <span class="n">search_se</span> <span class="o">%</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">)</span>

        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">search_se</span></div>

        <span class="c1"># import pdb; pdb.set_trace()</span>

<div class="viewcode-block" id="StreamingExpressions.get_join"><a class="viewcode-back" href="../../code/views.html#solr_front.views.StreamingExpressions.get_join">[documentos]</a>    <span class="k">def</span> <span class="nf">get_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">,</span> <span class="n">facets_col2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monta a expressao de Join para cada vertice do noh raiz.</span>
<span class="sd">        O Join eh a base para se recuperar dados e informacoes agregadas de duas</span>
<span class="sd">        collections ligadas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
        <span class="n">facets_col2</span> <span class="o">=</span> <span class="n">facets_col2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;*&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="n">selected_facets</span> <span class="o">=</span> <span class="n">selected_facets</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;*&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>

        <span class="c1"># Limpando sujeiras no mecanismo de facets.</span>
        <span class="c1"># Juntar todos os fqs na funcao do solr_queries.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_facets</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fq</span><span class="p">:</span>
            <span class="n">fq2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fq</span><span class="p">:</span>
            <span class="n">fq</span> <span class="o">=</span> <span class="s1">&#39;,fq=&#39;</span> <span class="o">+</span> <span class="n">fq</span>
        <span class="n">fq2</span> <span class="o">=</span> <span class="n">fq</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">selected_facets</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">:</span>
            <span class="n">vertice</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;relationship_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;one_to_many&#39;</span><span class="p">:</span>
                <span class="n">hash_join</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">                    hashJoin(</span>
<span class="s2">                      search(</span><span class="si">%s</span><span class="s2">, qt=&quot;/export&quot;,  q=*:*, fl=&quot;</span><span class="si">%s</span><span class="s2">&quot;, sort=&quot;</span><span class="si">%s</span><span class="s2"> asc&quot; </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                      hashed=cartesianProduct(</span>
<span class="s2">                        search(</span><span class="si">%s</span><span class="s2">, qt=&quot;/export&quot;, q=*:*, fl=&quot;</span><span class="si">%s</span><span class="s2">, id&quot;, sort=&quot;id asc&quot;,  fq=</span><span class="si">%s</span><span class="s2">:*, </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                      </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                    on=</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                    )</span>
<span class="s2">                &quot;&quot;&quot;</span>

                <span class="n">hash_join</span> <span class="o">=</span> <span class="n">hash_join</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">fq2</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;many&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;many&#39;</span><span class="p">],</span>
                    <span class="n">facets_col2</span><span class="p">,</span>
                    <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;many&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;many&#39;</span><span class="p">])</span>
                <span class="c1"># hash_join = (textwrap.fill(textwrap.dedent(hash_join))).replace(&#39;\n&#39;, &#39; &#39;)</span>
            <span class="k">elif</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;relationship_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;many_to_one&#39;</span><span class="p">:</span>
                <span class="n">hash_join</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">                    hashJoin(</span>
<span class="s2">                      search(</span><span class="si">%s</span><span class="s2">, qt=&quot;/export&quot;, q=*:*, fl=&quot;</span><span class="si">%s</span><span class="s2">, id&quot;, sort=&quot;</span><span class="si">%s</span><span class="s2"> asc&quot;,  fq=</span><span class="si">%s</span><span class="s2">:*, </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                      hashed=cartesianProduct(</span>
<span class="s2">                        select(</span>
<span class="s2">                            search(</span><span class="si">%s</span><span class="s2">, qt=&quot;/export&quot;,  q=*:*, fl=&quot;</span><span class="si">%s</span><span class="s2">, id&quot;, sort=&quot;id asc&quot; </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                        </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                      </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                    on=</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                    )</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="n">hash_join</span> <span class="o">=</span> <span class="n">hash_join</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">v</span><span class="p">,</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">facets_col2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;many&#39;</span><span class="p">],</span>
                    <span class="n">fq2</span><span class="p">,</span>
                    <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;many&#39;</span><span class="p">],</span> <span class="s1">&#39;id as id_2&#39;</span><span class="p">,</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;many&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;many&#39;</span><span class="p">])</span>
                <span class="c1"># hash_join = (textwrap.fill(textwrap.dedent(hash_join))).replace(&#39;\n&#39;, &#39; &#39;)</span>
            <span class="k">elif</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;relationship_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;one_to_one&#39;</span><span class="p">:</span>
                <span class="n">hash_join</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">                    innerJoin(</span>
<span class="s2">                      search(</span><span class="si">%s</span><span class="s2">, qt=&quot;/export&quot;, q=*:*, fl=&quot;</span><span class="si">%s</span><span class="s2">&quot;, sort=&quot;</span><span class="si">%s</span><span class="s2"> asc&quot;,  fq=</span><span class="si">%s</span><span class="s2">:*, </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                      search(</span><span class="si">%s</span><span class="s2">, qt=&quot;/export&quot;, q=*:*, fl=&quot;</span><span class="si">%s</span><span class="s2">&quot;, sort=&quot;</span><span class="si">%s</span><span class="s2"> asc&quot; </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                      on=&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="s2">                    )</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="n">hash_join</span> <span class="o">=</span> <span class="n">hash_join</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;from_one&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;from_one&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;from_one&#39;</span><span class="p">],</span> <span class="n">facets_col2</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span>
                    <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;to_one&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;to_one&#39;</span><span class="p">],</span> <span class="n">fq2</span><span class="p">,</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;from_one&#39;</span><span class="p">],</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;to_one&#39;</span><span class="p">])</span>
                <span class="c1"># hash_join = (textwrap.fill(textwrap.dedent(hash_join))).replace(&#39;\n&#39;, &#39; &#39;)</span>

            <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;\n\s+&#39;</span><span class="p">)</span>
            <span class="n">hash_join</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">hash_join</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

            <span class="n">hash_join</span> <span class="o">=</span> <span class="n">hash_join</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;%25&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_join</span>  <span class="c1"># Streaming expression de hashJoin</span></div>

<div class="viewcode-block" id="StreamingExpressions.get_count_joined"><a class="viewcode-back" href="../../code/views.html#solr_front.views.StreamingExpressions.get_count_joined">[documentos]</a>    <span class="k">def</span> <span class="nf">get_count_joined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">related_collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recupera o valor total de registros joins de duas collections &quot;&quot;&quot;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">related_collection</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">streaming_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">create_hash_querybuilder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;col1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span> <span class="s1">&#39;col2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;col2&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;col2&#39;</span><span class="p">][</span><span class="s1">&#39;parent_hash_querybuilder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">]</span>
        <span class="n">vertice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>

        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;null(unique(sort( </span><span class="si">%s</span><span class="s1">, by=&quot;</span><span class="si">%s</span><span class="s1"> asc&quot;),over=&quot;</span><span class="si">%s</span><span class="s1">&quot;),sort=&quot;</span><span class="si">%s</span><span class="s1"> asc&quot;)&#39;</span>

        <span class="c1"># Monta SE de contagem com base no SE JOIN</span>
        <span class="c1"># Metodo da Classe SolrQueries faz request no Solr e retorna Json.</span>
        <span class="c1"># Atribui resultado ao dict de contagem, no valor do vertice</span>
        <span class="c1"># Faz isso para col1 e col2</span>

        <span class="k">if</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;relationship_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;one_to_many&#39;</span><span class="p">:</span>
            <span class="n">count_sort_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;many&#39;</span><span class="p">]</span>
            <span class="n">count_col1</span> <span class="o">=</span> <span class="n">count</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">count_sort_field</span><span class="p">,</span> <span class="n">count_sort_field</span><span class="p">,</span> <span class="n">count_sort_field</span><span class="p">)</span>
            <span class="n">count_col2</span> <span class="o">=</span> <span class="n">count</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;relationship_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;many_to_one&#39;</span><span class="p">:</span>  <span class="c1"># Inverte</span>
            <span class="n">count_sort_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;many&#39;</span><span class="p">]</span>
            <span class="n">count_col2</span> <span class="o">=</span> <span class="n">count</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">count_sort_field</span><span class="p">,</span> <span class="n">count_sort_field</span><span class="p">,</span> <span class="n">count_sort_field</span><span class="p">)</span>
            <span class="n">count_col1</span> <span class="o">=</span> <span class="n">count</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="s1">&#39;id_2&#39;</span><span class="p">,</span> <span class="s1">&#39;id_2&#39;</span><span class="p">,</span> <span class="s1">&#39;id_2&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;relationship_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;one_to_one&#39;</span><span class="p">:</span>  <span class="c1"># Inverte</span>
            <span class="n">count_sort_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;from_one&#39;</span><span class="p">]</span>
            <span class="n">count_col2</span> <span class="o">=</span> <span class="n">count</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">count_sort_field</span><span class="p">,</span> <span class="n">count_sort_field</span><span class="p">,</span> <span class="n">count_sort_field</span><span class="p">)</span>
            <span class="n">count_col1</span> <span class="o">=</span> <span class="n">count</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>

        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="c1">#</span>
        <span class="c1">## Tirar as chamadas do solr_queries daqui e passar para o objeto que as usa.</span>
        <span class="c1">#</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">executaStreamingExpression</span><span class="p">(</span><span class="n">count_col1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;col1&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nullCount&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">executaStreamingExpression</span><span class="p">(</span><span class="n">count_col2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;col2&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nullCount&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="StreamingExpressions.get_top_joined"><a class="viewcode-back" href="../../code/views.html#solr_front.views.StreamingExpressions.get_top_joined">[documentos]</a>    <span class="k">def</span> <span class="nf">get_top_joined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">related_collection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recupera os ultimos n registros do join de duas collections &quot;&quot;&quot;</span>

        <span class="n">vertice</span> <span class="o">=</span> <span class="n">related_collection</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">[</span><span class="n">vertice</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">vertice</span><span class="p">][</span><span class="s1">&#39;relationship_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;one_to_one&#39;</span><span class="p">:</span>
            <span class="n">top_sort_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">vertice</span><span class="p">][</span><span class="s1">&#39;from_one&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">top_sort_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">vertice</span><span class="p">][</span><span class="s1">&#39;many&#39;</span><span class="p">]</span>

        <span class="n">top</span> <span class="o">=</span> <span class="s1">&#39;top(n=3,unique(sort( </span><span class="si">%s</span><span class="s1">, by=&quot;</span><span class="si">%s</span><span class="s1"> asc&quot;),over=&quot;</span><span class="si">%s</span><span class="s1">&quot;),sort=&quot;</span><span class="si">%s</span><span class="s1"> asc&quot;)&#39;</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">top</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">vertice</span><span class="p">],</span> <span class="n">top_sort_field</span><span class="p">,</span> <span class="n">top_sort_field</span><span class="p">,</span> <span class="n">top_sort_field</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">executaStreamingExpression</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">[</span><span class="n">vertice</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">[</span><span class="n">vertice</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">vertice</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
            <span class="k">raise</span></div></div>


<div class="viewcode-block" id="SolrQueries"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries">[documentos]</a><span class="k">class</span> <span class="nc">SolrQueries</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Encapsula as buscas no Solr &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">=</span> <span class="n">settings_sf</span><span class="o">.</span><span class="n">SOLR_URL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_stream_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">+</span> <span class="s1">&#39;/stream?expr=&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_qt</span> <span class="o">=</span> <span class="s1">&#39;/select&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash_querybuilder</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">campo_dinamico_busca</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span><span class="s1">&#39;campo_dinamico_busca&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="SolrQueries.solr_response_error"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.solr_response_error">[documentos]</a>    <span class="k">def</span> <span class="nf">solr_response_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method used to throw and log Solr response errors. &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;---------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Solr HTTP Response ERROR: </span><span class="si">%s</span><span class="s2"> ( </span><span class="si">%s</span><span class="s2"> ). Method: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;For HTTP 400 Solr log used to tell what is wrong with the request.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Solr URL Error: </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">solr_url</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;---------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">GetSolarDataException</span><span class="p">()</span></div>

<div class="viewcode-block" id="SolrQueries.executaStreamingExpression"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.executaStreamingExpression">[documentos]</a>    <span class="k">def</span> <span class="nf">executaStreamingExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">se</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Executes a standard Streaming Expression &quot;&quot;&quot;</span>
        <span class="c1"># Se necessario, fazer a conversao html entities geral.</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;%25&#39;</span><span class="p">)</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_stream_url</span> <span class="o">+</span> <span class="n">se</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;executaStreamingExpression&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="SolrQueries.sorlGenericConnection"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.sorlGenericConnection">[documentos]</a>    <span class="k">def</span> <span class="nf">sorlGenericConnection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Executa url do Solr a partir do raiz &quot;&quot;&quot;</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="n">select</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;sorlGenericConnection&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="SolrQueries.sorlJsonQuery"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.sorlJsonQuery">[documentos]</a>    <span class="k">def</span> <span class="nf">sorlJsonQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executa url json do Solr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span>

        <span class="c1"># Se necessario, fazer o escape de todos os caracterese que</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="n">solr_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;%25&#39;</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">solr_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;sorlJsonQuery&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="SolrQueries.facets2query"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.facets2query">[documentos]</a>    <span class="k">def</span> <span class="nf">facets2query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estrutura do Solr antigo, sem o Facets JSON. Solr 4.9.</span>
<span class="sd">        Monta uma string para busca de facet via URL e uma string para busca via StreamingExpressions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recebe os facets do front e converte para parametro fq do Solr.</span>
<span class="sd">        - Se selected_facets for uma lista de um mesmo attributo, considera todos</span>
<span class="sd">        adicionando o operador OR.</span>
<span class="sd">        - Inclue !tag para nao excluir os resultados filtrados.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fq_list = []</span>
<span class="sd">        for sf in selected_facets:</span>
<span class="sd">            for i in selected_facets[sf]:</span>
<span class="sd">                facet = sf + &#39;:&quot;&#39; + i + &#39;&quot;&#39;</span>
<span class="sd">                fq_list.append(facet)</span>

<span class="sd">        import pdb; pdb.set_trace()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fq_qstring</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">se_fqs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="c1"># {u&#39;bolsas_pt&#39;: [u&#39;01;Bolsas no Brasil&#39;], u&#39;situacao&#39;: [u&#39;Em andamento&#39;]}</span>

        <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">selected_facets</span><span class="p">:</span>
            <span class="c1"># categoria = sf.replace(&#39;_exact&#39;, &#39;&#39;)</span>
            <span class="n">categoria</span> <span class="o">=</span> <span class="n">sf</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_facets</span><span class="p">[</span><span class="n">sf</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># import pdb; pdb.set_trace()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_facets</span><span class="p">[</span><span class="n">sf</span><span class="p">]):</span>

                    <span class="k">if</span> <span class="n">i</span><span class="p">:</span>  <span class="c1"># O primeiro item do enumerate retorna falso</span>
                        <span class="n">fq</span> <span class="o">+=</span> <span class="s1">&#39;OR &quot;&#39;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span>
                        <span class="c1"># se_fq += &#39; fq=&#39; + categoria + &#39;:&quot;&#39; + item + &#39;&quot;, &#39;</span>
                        <span class="n">se_fq</span> <span class="o">+=</span> <span class="s1">&#39;OR &quot;&#39;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Primeiro item do enumerate</span>
                        <span class="c1"># import pdb; pdb.set_trace()</span>
                        <span class="n">fq</span> <span class="o">=</span> <span class="s1">&#39;&amp;fq={!tag=&#39;</span> <span class="o">+</span> <span class="n">categoria</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="n">categoria</span> <span class="o">+</span> <span class="s1">&#39;:( &quot;&#39;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span>
                        <span class="c1"># se_fq = &#39; fq={!tag=&#39; + categoria + &#39;_tag}&#39; + categoria + &#39;:(&quot;&#39; + item + &#39;&quot; &#39;</span>
                        <span class="n">se_fq</span> <span class="o">=</span> <span class="s1">&#39; fq=&#39;</span> <span class="o">+</span> <span class="n">categoria</span> <span class="o">+</span> <span class="s1">&#39;:(</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> &#39;</span>
                <span class="n">fq</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
                <span class="n">se_fq</span> <span class="o">+=</span> <span class="s1">&#39;),&#39;</span>
                <span class="c1"># import pdb; pdb.set_trace()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_facets</span><span class="p">[</span><span class="n">sf</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># import pdb; pdb.set_trace()</span>
                <span class="n">fq</span> <span class="o">=</span> <span class="s1">&#39;&amp;fq={!tag=&#39;</span> <span class="o">+</span> <span class="n">categoria</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="n">categoria</span> <span class="o">+</span> <span class="s1">&#39;:&quot;&#39;</span> <span class="o">+</span> <span class="n">selected_facets</span><span class="p">[</span><span class="n">sf</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                <span class="n">se_fq</span> <span class="o">=</span> <span class="s1">&#39; fq=&#39;</span> <span class="o">+</span> <span class="n">categoria</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">selected_facets</span><span class="p">[</span><span class="n">sf</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">,&#39;</span>
                <span class="c1"># se_fq = &#39; fq=&#39; + categoria + &#39;:&quot;&#39; + selected_facets[sf][0] + &#39;&quot;,&#39;</span>
                <span class="c1"># import pdb; pdb.set_trace()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">se_fq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;[&#39;</span> <span class="ow">in</span> <span class="n">fq</span><span class="p">:</span>
                <span class="n">fq</span> <span class="o">=</span> <span class="n">fq</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">se_fq</span> <span class="o">=</span> <span class="n">se_fq</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">fq</span><span class="p">:</span>
                <span class="n">fq</span> <span class="o">=</span> <span class="n">fq</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">fq_qstring</span> <span class="o">+=</span> <span class="n">fq</span>
            <span class="n">se_fqs</span> <span class="o">+=</span> <span class="n">se_fq</span>

            <span class="n">se_fqs</span> <span class="o">=</span> <span class="n">se_fqs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;*&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
            <span class="n">fq_qstring</span> <span class="o">=</span> <span class="n">fq_qstring</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;*&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>

            <span class="c1"># import pdb; pdb.set_trace()</span>

        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="c1"># Retorna dict com facets para a querystring e para a streaming_expression.</span>
        <span class="k">return</span> <span class="p">({</span><span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">:</span> <span class="n">fq_qstring</span><span class="p">,</span> <span class="s1">&#39;se_selected_facets&#39;</span><span class="p">:</span> <span class="n">se_fqs</span><span class="p">})</span></div>

<div class="viewcode-block" id="SolrQueries.facets2fq_post"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.facets2fq_post">[documentos]</a>    <span class="k">def</span> <span class="nf">facets2fq_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verificar se eh tudo o que precisa para recuperar os facets do front</span>
<span class="sd">        e converter em um unico fq para o Solr.</span>


<span class="sd">        !!!! Ver se dah para apgar o metodo acima</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lot</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of tuples</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">selected_facets</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c1"># import pdb; pdb.set_trace()</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="c1"># double quotes bumps Solr.</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="n">facets</span> <span class="o">+=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;&quot; OR &#39;</span>

            <span class="n">facets</span> <span class="o">=</span> <span class="n">facets</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; OR &#39;</span><span class="p">)</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="s1">&#39;{!tag=&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_tag}&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">facets</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

            <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">facets</span> <span class="o">=</span> <span class="s1">&#39;{!tag=&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_tag}&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;:*&#39;</span>

            <span class="n">lot</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">facets</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lot</span></div>

<div class="viewcode-block" id="SolrQueries.get_facets_json_api"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_facets_json_api">[documentos]</a>    <span class="k">def</span> <span class="nf">get_facets_json_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gera string de facet para pegar o resultado facetado na API JSON</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">facet_fields</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">json_facet</span> <span class="o">=</span> <span class="s1">&#39;{&#39;</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;FACETS&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;facetGroup&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;facets&#39;</span><span class="p">]:</span>
                    <span class="n">json_facet</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:{type:terms, field:&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span>
                        <span class="s1">&#39;chave&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,limit:5000, domain:{excludeTags:&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_tag}},&#39;</span>
                    <span class="n">facet_fields</span> <span class="o">+=</span> <span class="s1">&#39;&amp;json.facet={&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:{type:terms, field:&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span>
                        <span class="s1">&#39;chave&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,limit:5000, domain:{excludeTags:&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;}}}&#39;</span>

        <span class="n">json_facet</span> <span class="o">=</span> <span class="n">json_facet</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">json_facet</span> <span class="o">+=</span> <span class="s1">&#39;}&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">facet_fields</span><span class="p">,</span> <span class="n">json_facet</span><span class="p">)</span></div>

<div class="viewcode-block" id="SolrQueries.get_facet_4_autocomplete"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_facet_4_autocomplete">[documentos]</a>    <span class="k">def</span> <span class="nf">get_facet_4_autocomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">selected_facets</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recupera o facet de um elemento solicitado pelo autocomplete</span>
<span class="sd">        json.facet nao tem a opcao de facet.contains. Precisa usar o metodo get.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fq</span> <span class="o">=</span> <span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;fq&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">fq</span><span class="p">:</span>
            <span class="n">fq_split</span> <span class="o">=</span> <span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;fq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">fq_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fq_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">fq_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="n">fq</span> <span class="o">=</span> <span class="n">fq_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">term</span>
                <span class="n">fqs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">fq</span><span class="p">))</span>

        <span class="c1"># acrescente facets de contexto na lista de parametros fq</span>
        <span class="k">if</span> <span class="n">selected_facets</span><span class="p">:</span>
            <span class="n">fq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">facets2fq_post</span><span class="p">(</span><span class="n">selected_facets</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fq_tuple</span> <span class="ow">in</span> <span class="n">fq</span><span class="p">:</span>
                <span class="c1"># pega segundo valor da tupla retornada da função, como paramentro</span>
                <span class="n">fqs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">fq_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">+</span> <span class="s1">&#39;/select?&#39;</span>

        <span class="c1"># Essa regra funciona corretamente qdo ha um campo to tipo text para a busca e um campo facet para apresentar no autocomplete.</span>
        <span class="c1"># Esse eh um filtro de primeiro nivel no Solr. Como ha limitacao de filtragem de facet no Solr,</span>
        <span class="c1"># logo mais abaixo ha uma nova filtragem na camada da aplicacao.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;*:*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;facet.limit&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;facet.field&#39;</span><span class="p">,</span> <span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;facet.field&#39;</span><span class="p">]),</span> <span class="p">(</span><span class="s1">&#39;facet&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;facet.contains&#39;</span><span class="p">,</span> <span class="n">fq_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="s1">&#39;facet.contains.ignoreCase&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">fqs</span>

        <span class="n">solr_url</span> <span class="o">+=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Se necessario, fazer o escape de todos os caracterese que</span>
        <span class="c1"># solr_url = solr_url.replace(&#39;%&#39;, &#39;%25&#39;)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;get_facet_4_autocomplete&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="n">json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;facet_counts&#39;</span> <span class="ow">in</span> <span class="n">json</span><span class="p">:</span>
            <span class="n">resultado</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s1">&#39;facet_counts&#39;</span><span class="p">][</span><span class="s1">&#39;facet_fields&#39;</span><span class="p">][</span><span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;facet.field&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">resultado</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
                <span class="c1"># Filtro manual, pode causar lentidao.</span>
                <span class="c1"># O Solr nao filtra facet com multiplos contains,</span>
                <span class="c1"># por isso precisa filtrar aqui na camada da aplicacao.</span>
                <span class="c1"># Verifica se os facets resultantes tem as strings buscadas.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fq_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">fq_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
                    <span class="k">continue</span>
                <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
            <span class="k">return</span> <span class="p">({</span><span class="s1">&#39;buckets&#39;</span><span class="p">:</span> <span class="n">docs</span><span class="p">})</span></div>

<div class="viewcode-block" id="SolrQueries.get_facets_json_api_sum"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_facets_json_api_sum">[documentos]</a>    <span class="k">def</span> <span class="nf">get_facets_json_api_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sum_field</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Soma todos os valores de um determinado facet &quot;&quot;&quot;</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="s1">&#39;{sum:&quot;sum(&#39;</span> <span class="o">+</span> <span class="n">sum_field</span> <span class="o">+</span> <span class="s1">&#39;)&quot;}&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;*:*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;json.facet&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">)]</span> <span class="o">+</span> <span class="n">selected_facets</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="SolrQueries.get_facets_json_api_avg"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_facets_json_api_avg">[documentos]</a>    <span class="k">def</span> <span class="nf">get_facets_json_api_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg_field</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retorna a media dos valores numericos de um facet &quot;&quot;&quot;</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="s1">&#39;{avg:&quot;avg(&#39;</span> <span class="o">+</span> <span class="n">avg_field</span> <span class="o">+</span> <span class="s1">&#39;)&quot;}&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;*:*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">fq</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;json.facet&#39;</span><span class="p">,</span> <span class="n">avg</span><span class="p">)]</span> <span class="o">+</span> <span class="n">selected_facets</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="SolrQueries.get_facets_json_api_unique"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_facets_json_api_unique">[documentos]</a>    <span class="k">def</span> <span class="nf">get_facets_json_api_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_field</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recupera a qt de valores unicos para um determinado facet &quot;&quot;&quot;</span>
        <span class="n">se</span> <span class="o">=</span> <span class="s1">&#39;null(unique(search(</span><span class="si">%s</span><span class="s1">, qt=&quot;/export&quot;, q=*:*, fl=&quot;</span><span class="si">%s</span><span class="s1">&quot;, sort=&quot;</span><span class="si">%s</span><span class="s1"> asc&quot;, </span><span class="si">%s</span><span class="s1">),over=&quot;</span><span class="si">%s</span><span class="s1">&quot;),)&#39;</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">se</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">unique_field</span><span class="p">,</span> <span class="n">unique_field</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">,</span> <span class="n">unique_field</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executaStreamingExpression</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;result-set&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nullCount&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SolrQueries.create_hash_querybuilder"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.create_hash_querybuilder">[documentos]</a>    <span class="k">def</span> <span class="nf">create_hash_querybuilder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cada busca do querybuilder e os filtros do facet (incluir os facets) teem um</span>
<span class="sd">        hash, que eh um campo dinamico criado na collection relacionada.</span>
<span class="sd">        Por exemplo, ao buscar publicacoes de processos filtrados, as publicacoes</span>
<span class="sd">        passam a ter esse campo, para que esse subconjunto seja identificado e possa</span>
<span class="sd">        ser trabalhdo (filtrado).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">streaming_expression</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span><span class="p">))</span></div>

<div class="viewcode-block" id="SolrQueries.update_atomico"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.update_atomico">[documentos]</a>    <span class="k">def</span> <span class="nf">update_atomico</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">collection2</span><span class="p">,</span> <span class="n">campo_dinamico_busca</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param: url Chamada para o Solr via StreamingExpressions para recuperar o id dos objetos que</span>
<span class="sd">        serao indexados (funil).</span>
<span class="sd">        @param: collection2 Collection que serah reindexada (funil)</span>
<span class="sd">        @param: campo_dinamico_busca Nao estah usando</span>
<span class="sd">        Faz update atomico da collection solicitada</span>
<span class="sd">        Recebe uma lista e manda de uma vez para o Solr, que cuida fazer o update</span>
<span class="sd">        no documento, criando ou excluindo o campo enviando no &quot;jsons_ids&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">monta_json_para_update</span><span class="p">(</span><span class="n">campo</span><span class="p">,</span> <span class="n">operador</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            :param valor_campo: utilizado para criar ou excluir campo dinamico no Solr</span>
<span class="sd">            :type valor_campo: Tipo string. Valores aceitos sao &#39;true&#39; e vazio</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># Executa o request no Solr e recupera os documentos que jah estao indexados.</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;monta_json_para_update&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">related_collection_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Prepara o uma lista de dict para fazer o update atomico.</span>
<span class="sd">            Como o algoritmo map reduce acima retorna publicacoes repetidas, o update</span>
<span class="sd">            eh repetido, gerando overhead. Eh preciso melhorar o algoritmo acima de</span>
<span class="sd">            map reduce, ou o update.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">json_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">related_collection_json</span><span class="p">[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
                    <span class="n">json_ids</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="n">campo</span><span class="p">:</span> <span class="p">{</span><span class="n">operador</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">}</span>
                    <span class="p">})</span>
            <span class="k">return</span> <span class="n">json_ids</span>

        <span class="c1"># Indexa atomicamente (cria campos dinamicos nos documentos enviados em jsons_ids)</span>
        <span class="n">json_ids</span> <span class="o">=</span> <span class="n">monta_json_para_update</span><span class="p">(</span><span class="n">campo_dinamico_busca</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">)</span>

        <span class="c1"># Chamar o Celery</span>
        <span class="n">update_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="n">collection2</span> <span class="o">+</span> <span class="s1">&#39;/update?commit=true&#39;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">json_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;update_atomico&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">update_url</span><span class="p">)</span></div>

<div class="viewcode-block" id="SolrQueries.get_or_create_related_collection_db"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_or_create_related_collection_db">[documentos]</a>    <span class="k">def</span> <span class="nf">get_or_create_related_collection_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">streaming_expression</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica se contagem (count e top) das collections relacionadas</span>
<span class="sd">        estao armazenadas no DB.</span>
<span class="sd">            1. Sim - retorna para o template mostrar</span>
<span class="sd">            2. Nao - contabiliza novamente, armazena e retorna para o template.</span>
<span class="sd">        Se nao estiver no banco:</span>
<span class="sd">            Contabiliza, armazena e retorna para o template.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_count_get_top</span><span class="p">(</span><span class="n">streaming_expression</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
            <span class="n">streaming_expression</span><span class="o">.</span><span class="n">get_count_joined</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="n">streaming_expression</span><span class="o">.</span><span class="n">get_top_joined</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>

            <span class="n">count</span> <span class="o">=</span> <span class="n">streaming_expression</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">streaming_expression</span><span class="o">.</span><span class="n">top</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>

        <span class="c1"># Se registro jah existe no banco</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">related_collection_chk</span> <span class="o">=</span> <span class="n">RelatedCollectionsCheck</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hash_querybuilder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">)</span>
            <span class="c1"># Se nao precisar recontar, retorna objeto recuperado.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">related_collection_chk</span><span class="o">.</span><span class="n">recount</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">related_collection_chk</span>
            <span class="c1"># Senao, reconta, grava e retorna objeto atualizado.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_count_get_top</span><span class="p">(</span><span class="n">streaming_expression</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
                <span class="n">related_collection_chk</span><span class="o">.</span><span class="n">join</span> <span class="o">=</span> <span class="n">streaming_expression</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>
                <span class="n">related_collection_chk</span><span class="o">.</span><span class="n">qt_col1</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">related_collection_chk</span><span class="o">.</span><span class="n">qt_col2</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="c1"># Senao, cria registro no banco.</span>
        <span class="k">except</span> <span class="n">RelatedCollectionsCheck</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2"> Does not exist&quot;</span>
            <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_count_get_top</span><span class="p">(</span><span class="n">streaming_expression</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">related_collection_chk</span> <span class="o">=</span> <span class="n">RelatedCollectionsCheck</span><span class="p">(</span><span class="n">hash_querybuilder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">,</span>
                                                             <span class="n">join</span><span class="o">=</span><span class="n">streaming_expression</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">collection</span><span class="p">],</span>
                                                             <span class="n">qt_col1</span><span class="o">=</span><span class="n">count</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                                                             <span class="n">qt_col2</span><span class="o">=</span><span class="n">count</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                                                             <span class="p">)</span>
        <span class="n">related_collection_chk</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">related_collection_chk</span></div>

<div class="viewcode-block" id="SolrQueries.do_reindex"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.do_reindex">[documentos]</a>    <span class="k">def</span> <span class="nf">do_reindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">collection_destino</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streaming_expression</span> <span class="o">=</span> <span class="n">se</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @params: se StreamingExpressions que gera url para recuperar o id dos documentos</span>
<span class="sd">        que serao reindexados (funil)</span>
<span class="sd">        @params: collection_destino Collection que serah reindexada (funil)</span>

<span class="sd">        Abre thread para indexar os documentos relacionados.</span>
<span class="sd">        Melhorar essa verificacao pq em muitos casos nao vai haver docs relacionados pelo</span>
<span class="sd">        fato de que realmente nao existem docs relacionados para muitas buscas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="s2">&quot;graph_auxilios/stream?expr=&quot;</span> <span class="o">+</span> <span class="n">se</span>

        <span class="c1"># print</span>
        <span class="c1"># print collection_destino</span>
        <span class="c1"># print self.campo_dinamico_busca</span>
        <span class="c1"># print self.hash_querybuilder</span>

        <span class="c1"># Metodo deley eh do celery.</span>
        <span class="k">if</span> <span class="n">settings_sf</span><span class="o">.</span><span class="n">USE_CELERY</span><span class="p">:</span>
            <span class="n">pedido</span> <span class="o">=</span> <span class="n">update_atomico_celery</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">collection_destino</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">campo_dinamico_busca</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">)</span>
        <span class="c1"># else:</span>
        <span class="c1"># Desta maneira, nao chama no Celery, chama diretamente no script da task.</span>
        <span class="c1">#    pedido = update_atomico_celery(url, collection_destino, self.campo_dinamico_busca, self.hash_querybuilder)</span>

        <span class="k">return</span> <span class="n">pedido</span></div>

<div class="viewcode-block" id="SolrQueries.get_content"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_content">[documentos]</a>    <span class="k">def</span> <span class="nf">get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="n">facet_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_facets_json_api</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="n">content_type</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;*:*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">fq</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;json.facet&#39;</span><span class="p">,</span> <span class="n">facet_fields</span><span class="p">)]</span> <span class="o">+</span> <span class="n">selected_facets</span>

        <span class="c1"># Se necessario, fazer o escape de todos os caracterese que</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="n">solr_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;%25&#39;</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">solr_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;get_content&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="SolrQueries.get_totalizador"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_totalizador">[documentos]</a>    <span class="k">def</span> <span class="nf">get_totalizador</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">docs</span><span class="p">):</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
        <span class="c1"># Transforma o field label no retorno do json do Solr.</span>
        <span class="k">if</span> <span class="s1">&#39;url&#39;</span> <span class="ow">in</span> <span class="n">docs</span> <span class="ow">and</span> <span class="s1">&#39;text&#39;</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="s1">&#39;url:&#39;</span> <span class="o">+</span> <span class="n">docs</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, text:&#39;</span> <span class="o">+</span> <span class="n">docs</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
        <span class="c1"># Limpa os campos que passam a query para o solr, como por exemplo: auxilio:&quot;*&quot;</span>

        <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;*&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fq</span><span class="p">:</span>
            <span class="n">fq</span> <span class="o">=</span> <span class="s1">&#39;fq=&#39;</span> <span class="o">+</span> <span class="n">fq</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/query?q=*:*&amp;rows=3&amp;</span><span class="si">%s%s</span><span class="s1">&amp;fl=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">content_type</span><span class="p">),</span> <span class="n">fq</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">fl</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;get_totalizador&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">({</span><span class="s1">&#39;numFound&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">],</span> <span class="s1">&#39;docs&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">]})</span></div>

<div class="viewcode-block" id="SolrQueries.get_content_json_facet"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_content_json_facet">[documentos]</a>    <span class="k">def</span> <span class="nf">get_content_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">json_facet</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Metodo chamado pelo Ajax para montar o grafico multinivel.</span>
<span class="sd">        Utilizar a estrutura de facet multinivel do Solr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">facet_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_facets_json_api</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="n">content_type</span> <span class="o">+</span> <span class="s1">&#39;/query?q=*:*&amp;rows=0&amp;json.facet=&#39;</span> <span class="o">+</span> <span class="n">json_facet</span> <span class="o">+</span> <span class="s1">&#39;&amp;fq=&#39;</span> <span class="o">+</span> <span class="n">fq</span> <span class="o">+</span> <span class="n">selected_facets</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;get_content_json_facet&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="SolrQueries.get_content_boxplot_json_facet"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_content_boxplot_json_facet">[documentos]</a>    <span class="k">def</span> <span class="nf">get_content_boxplot_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">levels_list</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recupera dados facetados no Solr e retorna dois objetos para o front end</span>
<span class="sd">        para geracao do grafico d3js boxplot.</span>
<span class="sd">        http://yonik.com/percentiles-for-solr-faceting/</span>

<span class="sd">        !!! Acertar o threshold...</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># levels_list = []</span>
        <span class="c1"># levels_list.append({&#39;nivel_1&#39;:&#39;Idade&#39;, &#39;nivel_2&#39;:&#39;Vl_Rem_Novembro_CC&#39;})</span>
        <span class="c1"># content_type = &#39;rais&#39;</span>

        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="n">content_type</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span>

        <span class="c1"># Recebe as variaveis do grafico.</span>
        <span class="n">json_facet</span> <span class="o">=</span> <span class="s1">&#39;{x_axis:{type: terms, field:&#39;</span> <span class="o">+</span> <span class="n">levels_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span>

            <span class="s1">&#39;nivel_1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, limit: -1, facet:{y_axis:&quot;percentile(&#39;</span> <span class="o">+</span> <span class="n">levels_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span>
                         <span class="s1">&#39;nivel_2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,25,50,75)&quot;,avg:&quot;avg(&#39;</span> <span class="o">+</span> <span class="n">levels_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;nivel_2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&quot;}}}&#39;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;*:*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">fq</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;json.facet&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_facet</span><span class="p">))]</span> <span class="o">+</span> <span class="n">selected_facets</span>
        <span class="c1"># data = [(&#39;q&#39;, &#39;-&#39;+levels_list[1][&#39;nivel_2&#39;]+&#39;:0&#39;), (&#39;rows&#39;, &#39;0&#39;), (&#39;fl&#39;, &#39;*&#39;), (&#39;fq&#39;, fq), (&#39;json.facet&#39;, str(json_facet))] + selected_facets</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;get_content_boxplot_json_facet&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="c1"># Caso o Solr tenha retornado um json</span>
        <span class="n">response_json</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_tick</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x_elemen</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;facets&#39;</span><span class="p">][</span><span class="s1">&#39;x_axis&#39;</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]:</span>
            <span class="c1"># Considera somente primeiro nivel do facet, no caso de utilziar um campo facetado.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c1"># Considera somente primeiro nivel do facet, no caso de utilziar um campo facetado.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">]</span><span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">facet</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x_axis&quot;</span><span class="p">:</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                         <span class="s2">&quot;y_axis&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;quartile1&quot;</span><span class="p">:</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;y_axis&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;y_axis&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="s2">&quot;quartile3&quot;</span><span class="p">:</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;y_axis&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span><span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">]}}</span>
            <span class="n">response_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">facet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response_json</span></div>

<div class="viewcode-block" id="SolrQueries.get_content_wordcloud_json_facet"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_content_wordcloud_json_facet">[documentos]</a>    <span class="k">def</span> <span class="nf">get_content_wordcloud_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">single_facet</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recupera dados facetados no Solr de um unico campo, e retorna para geracao do grafico wordcloud.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="n">content_type</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span>
        <span class="c1"># facet_field = &#39;aval_sug_facet&#39;</span>
        <span class="n">facet_field</span> <span class="o">=</span> <span class="n">single_facet</span>
        <span class="n">json_facet</span> <span class="o">=</span> <span class="s1">&#39;{single_facet:{type: terms, field:&#39;</span> <span class="o">+</span> <span class="n">facet_field</span> <span class="o">+</span> <span class="s1">&#39;, sort:{count:desc}, limit: 1000 }}&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;*:*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">fq</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;json.facet&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_facet</span><span class="p">))]</span> <span class="o">+</span> <span class="n">selected_facets</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;get_content_json_facet&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="c1"># Convertendo a chave dos objetos para ficar compativel com a lib d3wordcloud no front</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;facets&#39;</span><span class="p">][</span><span class="s1">&#39;single_facet&#39;</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;buckets&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">buckets</span><span class="p">[</span><span class="s1">&#39;buckets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">buckets</span></div>

<div class="viewcode-block" id="SolrQueries.get_content_bubble_json_facet"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_content_bubble_json_facet">[documentos]</a>    <span class="k">def</span> <span class="nf">get_content_bubble_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">levels_list</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recupera dados facetados no Solr e retorna dois objetos para o front end</span>
<span class="sd">        para geracao do grafico d3js Bubble.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="n">content_type</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span>

        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="c1"># Recebe as variaveis do grafico.</span>
        <span class="n">json_facet</span> <span class="o">=</span> <span class="s1">&#39;{x_axis:{type: terms, field:&#39;</span> <span class="o">+</span> <span class="n">levels_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span>
            <span class="s1">&#39;nivel_1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, sort:{count:asc}, limit:5000 , facet:{y_axis:{type: terms,field: &#39;</span> <span class="o">+</span> <span class="n">levels_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span>
                         <span class="s1">&#39;nivel_2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,sort:{count:asc},limit: 5000}}}}&#39;</span>

        <span class="c1"># print json.dumps(response.json(), indent=4, sort_keys=&#39;true&#39;)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;*:*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">fq</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;json.facet&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_facet</span><span class="p">))]</span> <span class="o">+</span> <span class="n">selected_facets</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;get_content_json_facet&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Caso o Solr tenha retornado um json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response_json</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_tick</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x_elemen</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;facets&#39;</span><span class="p">][</span><span class="s1">&#39;x_axis&#39;</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]:</span>
            <span class="c1"># Considera somente primeiro nivel do facet, no caso de utilziar um campo facetado.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">y_tick</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">y_elemen</span> <span class="ow">in</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;y_axis&#39;</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]:</span>
                <span class="c1"># Considera somente primeiro nivel do facet, no caso de utilziar um campo facetado.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">y_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">facet</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;y_elemen&#39;</span><span class="p">:</span> <span class="n">y_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;x_elemen&#39;</span><span class="p">:</span> <span class="n">x_elemen</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">y_elemen</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="s1">&#39;x_tick&#39;</span><span class="p">:</span> <span class="n">x_tick</span><span class="p">,</span> <span class="s1">&#39;y_tick&#39;</span><span class="p">:</span> <span class="n">y_tick</span><span class="p">}</span>
                <span class="n">response_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">facet</span><span class="p">)</span>
                <span class="n">y_tick</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">x_tick</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">response_json</span></div>

<div class="viewcode-block" id="SolrQueries.get_content_sankey_json_facet"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_content_sankey_json_facet">[documentos]</a>    <span class="k">def</span> <span class="nf">get_content_sankey_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">levels_list</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recupera dados facetados no Solr e retorna dois objetos para o front end</span>
<span class="sd">        para geracao do grafico d3js Sankey.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">json_facet</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">levels_list</span><span class="p">):</span>
            <span class="n">nivel</span> <span class="o">=</span> <span class="s1">&#39;nivel_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">json_facet</span> <span class="o">=</span> <span class="s1">&#39;{&quot;&#39;</span> <span class="o">+</span> <span class="n">nivel</span> <span class="o">+</span> <span class="s1">&#39;&quot;:{&quot;field&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="n">val</span><span class="p">[</span><span class="n">nivel</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;type&quot;: &quot;terms&quot;, &quot;limit&quot;: 5000&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json_facet</span> <span class="o">+=</span> <span class="s1">&#39;, &quot;facet&quot;:{&quot;&#39;</span> <span class="o">+</span> <span class="n">nivel</span> <span class="o">+</span> <span class="s1">&#39;&quot;:{&quot;field&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="n">val</span><span class="p">[</span>
                    <span class="n">nivel</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;type&quot;: &quot;terms&quot;, &quot;limit&quot;: 5000}}&#39;</span>
        <span class="n">json_facet</span> <span class="o">+=</span> <span class="s1">&#39;}}&#39;</span>
        <span class="n">json_facet</span> <span class="o">=</span> <span class="n">json_facet</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="n">content_type</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;*:*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">fq</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;json.facet&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_facet</span><span class="p">))]</span> <span class="o">+</span> <span class="n">selected_facets</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;get_content_sankey_json_facet&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># Utiliza dict para facilitar a busca do elemento</span>

        <span class="k">def</span> <span class="nf">rec_niveis</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">nivel</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            recupera recursivamente os niveis do facet.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">nivel_str</span> <span class="o">=</span> <span class="s1">&#39;nivel_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nivel</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">nivel_str</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Se nao tem o nivel_str no facet, quer dizer que estah no ultimo nivel e finaliza a recursao.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">f_dict</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">[</span><span class="n">nivel_str</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Considera somente primeiro nivel do facet, no caso de utilziar um campo facetado.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;val&#39;</span> <span class="ow">in</span> <span class="n">f_dict</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span>
                            <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="n">e</span>

                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Itera o objeto e remonta para a estrutura do grafico d3js.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># Altera o nome da chave para nao haver colisao.</span>
                <span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nivel</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">nodes</span><span class="p">[</span><span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
                    <span class="c1"># if nodes[source] == nodes[f_dict[&#39;val&#39;]]:</span>
                    <span class="c1">#     continue</span>
                    <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">nodes</span><span class="p">[</span><span class="n">source</span><span class="p">],</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">nodes</span><span class="p">[</span><span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]],</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]})</span>
                <span class="n">rec_nivel</span> <span class="o">=</span> <span class="n">nivel</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">rec_niveis</span><span class="p">(</span><span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="n">f_dict</span><span class="p">,</span> <span class="n">rec_nivel</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Caso o Solr tenha retornado um json, chama funcao recursiva para</span>
<span class="sd">            montar a estrutura de dados do grafico sankey.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">rec_niveis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;facets&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SolrQueries.get_content_pivot_table_json_facet"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SolrQueries.get_content_pivot_table_json_facet">[documentos]</a>    <span class="k">def</span> <span class="nf">get_content_pivot_table_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">levels_list</span><span class="p">,</span> <span class="n">selected_facets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recupera dados facetados no Solr e retorna dois objetos para o front end</span>
<span class="sd">        para geracao da tabela OLAP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_facet</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">levels_list</span><span class="p">):</span>
            <span class="n">nivel</span> <span class="o">=</span> <span class="s1">&#39;nivel_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">json_facet</span> <span class="o">=</span> <span class="s1">&#39;{&quot;&#39;</span> <span class="o">+</span> <span class="n">nivel</span> <span class="o">+</span> <span class="s1">&#39;&quot;:{&quot;field&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="n">val</span><span class="p">[</span><span class="n">nivel</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;type&quot;: &quot;terms&quot;, &quot;limit&quot;: 5000&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json_facet</span> <span class="o">+=</span> <span class="s1">&#39;, &quot;facet&quot;:{&quot;&#39;</span> <span class="o">+</span> <span class="n">nivel</span> <span class="o">+</span> <span class="s1">&#39;&quot;:{&quot;field&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="n">val</span><span class="p">[</span>
                    <span class="n">nivel</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;type&quot;: &quot;terms&quot;, &quot;limit&quot;: 5000}}&#39;</span>

        <span class="n">json_facet</span> <span class="o">+=</span> <span class="s1">&#39;}}&#39;</span>

        <span class="n">json_facet</span> <span class="o">=</span> <span class="n">json_facet</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_connection</span> <span class="o">+</span> <span class="n">content_type</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;*:*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fq&#39;</span><span class="p">,</span> <span class="n">fq</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;json.facet&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_facet</span><span class="p">))]</span> <span class="o">+</span> <span class="n">selected_facets</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solr_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_response_error</span><span class="p">(</span><span class="s1">&#39;get_content_pivot_table_json_facet&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># Utiliza dict para facilitar a busca do elemento</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Ano&#39;</span><span class="p">],</span> <span class="s1">&#39;cols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Situação&#39;</span><span class="p">]}</span>

        <span class="k">def</span> <span class="nf">rec_niveis</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">facets</span><span class="p">,</span> <span class="n">nivel</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            recupera recursivamente os niveis do facet.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">nivel_str</span> <span class="o">=</span> <span class="s1">&#39;nivel_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nivel</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">nivel_str</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Se nao tem o nivel_str no facet, quer dizer que estah no ultimo nivel e finaliza a recursao.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">f_dict</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">[</span><span class="n">nivel_str</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Itera o objeto e remonta para a estrutura do grafico d3js.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># Altera o nome da chave para nao haver colisao.</span>
                <span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nivel</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">nodes</span><span class="p">[</span><span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nodes</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodes</span><span class="p">[</span><span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]]:</span>
                        <span class="k">continue</span>
                    <span class="c1"># import pdb; pdb.set_trace()</span>

                    <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]})</span>
                <span class="n">rec_nivel</span> <span class="o">=</span> <span class="n">nivel</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">rec_niveis</span><span class="p">(</span><span class="n">f_dict</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="n">f_dict</span><span class="p">,</span> <span class="n">rec_nivel</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Caso o Solr tenha retornado um json, chama funcao recursiva para</span>
<span class="sd">            montar a estrutura de dados do grafico sankey.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">rec_niveis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;facets&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>


<span class="c1">######################</span>
<span class="c1">### EntryPointView ###</span>
<span class="c1">######################</span>

<div class="viewcode-block" id="EntryPointView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.EntryPointView">[documentos]</a><span class="k">class</span> <span class="nc">EntryPointView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classe pai de SearchView, RelatedCollection, #Collection2View e VinculadosView</span>
<span class="sd">    Recupera todos os valores do request, trata os dados do json enviados pelo front e</span>
<span class="sd">    converte para o formato do Solr.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Pesquisa</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;base_sf.html&#39;</span>

<div class="viewcode-block" id="EntryPointView.dispatch"><a class="viewcode-back" href="../../code/views.html#solr_front.views.EntryPointView.dispatch">[documentos]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Trying access to a not known collection.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s2">&quot;Collection does not exist&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;template&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="o">=</span> <span class="n">find_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span> <span class="o">=</span> <span class="n">SolrQueries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash_querybuilder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">GRAPH</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body_json</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span> <span class="o">=</span> <span class="n">NavigateCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">get_vertice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>

        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="c1"># Converte os facets do front para a string do Solr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_facets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">facets2query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;selected_facets_col1&#39;</span><span class="p">])</span>

        <span class="c1"># Caso esse metodo funcione, substituir o acima.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_selected_facets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">facets2fq_post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;selected_facets_col1&#39;</span><span class="p">])</span>

        <span class="c1"># Caso tenha uma query, transforma para query do Solr.</span>
        <span class="c1"># ALterer o front para sempre mandar esses paramentros vazios.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;null&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="n">ultimo</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_json</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s1">&#39;rules&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">solr_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_response</span><span class="p">()</span>
            <span class="c1"># import pdb; pdb.set_trace()</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">solr_json</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Class Error: EntryPointView&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Subclass Error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;URL Error: </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()))</span></div>

<div class="viewcode-block" id="EntryPointView.update_vertice"><a class="viewcode-back" href="../../code/views.html#solr_front.views.EntryPointView.update_vertice">[documentos]</a>    <span class="k">def</span> <span class="nf">update_vertice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">initial_search</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">]:</span>
            <span class="n">initial_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">get_search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_facets</span><span class="p">[</span><span class="s1">&#39;se_selected_facets&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">update_vertice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body_json</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_facets</span><span class="p">,</span> <span class="n">initial_search</span><span class="p">)</span></div>

<div class="viewcode-block" id="EntryPointView.split_value"><a class="viewcode-back" href="../../code/views.html#solr_front.views.EntryPointView.split_value">[documentos]</a>    <span class="k">def</span> <span class="nf">split_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">lego</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="c1"># modifica mecanica de palavras chaves incluindo aspas em cada palavra</span>
            <span class="k">for</span> <span class="n">frase</span> <span class="ow">in</span> <span class="n">lego</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">frase</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="s1">&#39; OR &#39;</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">frase</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span></div>

<div class="viewcode-block" id="EntryPointView.dict_to_solr"><a class="viewcode-back" href="../../code/views.html#solr_front.views.EntryPointView.dict_to_solr">[documentos]</a>    <span class="k">def</span> <span class="nf">dict_to_solr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converte as regras recebidas do frontend em operacoes do Solr.</span>
<span class="sd">        Os dicionarios &quot;dict_operators&quot; traduzem os operadores do front em operacoes</span>
<span class="sd">        do Solr. Cada operador do dict tem a estrutura correta com placeholders</span>
<span class="sd">        que recebem os argumentos e entrega a expressao do Solr pronta.</span>
<span class="sd">        Sao 3 dicts, um que espera um argumento, um que espera dois argumentos e</span>
<span class="sd">        um que espera 3 argumentos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_operators_1</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;operator&#39;</span><span class="p">]]</span> <span class="o">%</span> <span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">])</span>

        <span class="c1"># Por enquanto somente para data</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># return self.dict_operators_3[dict[&#39;operator&#39;]] % (dict[&#39;field&#39;], dict[&#39;value&#39;][0], dict[&#39;value&#39;][1])</span>
            <span class="k">return</span> <span class="s1">&#39;data_inicio_ano:[</span><span class="si">%s</span><span class="s1"> TO *] AND data_termino_ano:[</span><span class="si">%s</span><span class="s1"> TO *]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># import pdb; pdb.set_trace()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

            <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;data_inicio&#39;</span><span class="p">:</span>
                <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;data_inicio_ano&#39;</span>
            <span class="k">if</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;data_termino&#39;</span><span class="p">:</span>
                <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;data_termino_ano&#39;</span>

            <span class="k">if</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
                <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_operators_2</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;operator&#39;</span><span class="p">]]</span> <span class="o">%</span> <span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_value</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="EntryPointView.rec_json"><a class="viewcode-back" href="../../code/views.html#solr_front.views.EntryPointView.rec_json">[documentos]</a>    <span class="k">def</span> <span class="nf">rec_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">ultimo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recebe json do front com os filtros e converte em um unico parametro fq.</span>
<span class="sd">        Essa funcao eh recursiva para interpretar recursivamente a arvore de filtros</span>
<span class="sd">        (arquivo json enviado pelo frontend).</span>
<span class="sd">        A variavel fq eh concatenada sucessivamente para montar uma expressao logica</span>
<span class="sd">        (filtragem a ser passada para o Solr).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="nb">dict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rules</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fq</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span>
            <span class="k">if</span> <span class="n">ultimo</span><span class="p">:</span>
                <span class="n">fq</span> <span class="o">+=</span> <span class="n">condition</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="n">ultimo</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Qdo tem somente uma regra, tira da lista e joga no dict.</span>
            <span class="k">if</span> <span class="s1">&#39;rules&#39;</span> <span class="ow">in</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;rules&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;rules&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;rules&#39;</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>  <span class="c1"># Se for uma regra, monta a chamada.</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Regra solitaria, sem irmaos</span>
                    <span class="n">fq</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_to_solr</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) &#39;</span>
                <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Ultima regra</span>
                    <span class="n">fq</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_to_solr</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) &#39;</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">fq</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Primeira regra e regras intermediarias</span>
                    <span class="n">fq</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_to_solr</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Se for uma lista de regras, chama recursivamente.</span>
                <span class="p">(</span><span class="n">fq</span><span class="p">,</span> <span class="n">ultimo</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_json</span><span class="p">(</span><span class="n">fq</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;rules&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Se houver mais de um rules o ultimo &#39;rules&#39;, significando que existe no minimo uma</span>
                <span class="c1"># indentacao de rules, e o ultimo rules sair, incluir um parenteses no final.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">idx</span><span class="p">):</span>
                    <span class="n">fq</span> <span class="o">+=</span> <span class="s1">&#39;) &#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ultimo</span><span class="p">:</span>
                <span class="n">fq</span> <span class="o">+=</span> <span class="n">condition</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">fq</span><span class="p">,</span> <span class="n">ultimo</span><span class="p">)</span></div>

<div class="viewcode-block" id="EntryPointView.consolida_totalizador"><a class="viewcode-back" href="../../code/views.html#solr_front.views.EntryPointView.consolida_totalizador">[documentos]</a>    <span class="k">def</span> <span class="nf">consolida_totalizador</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solr_json</span><span class="p">,</span> <span class="n">generic_json</span><span class="p">,</span> <span class="n">totalizador</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Metodo utilizado nas classes TotalizadorView e RelatedCollection &quot;&quot;&quot;</span>
        <span class="n">generic_json</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span>
        <span class="n">generic_json</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;colunas&#39;</span> <span class="ow">in</span> <span class="n">totalizador</span><span class="p">:</span>
            <span class="n">generic_json</span><span class="p">[</span><span class="s1">&#39;colunas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;colunas&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">totalizador</span><span class="p">:</span>
            <span class="n">generic_json</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;data_type&#39;</span> <span class="ow">in</span> <span class="n">totalizador</span><span class="p">:</span>
            <span class="n">generic_json</span><span class="p">[</span><span class="s1">&#39;data_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;data_type&#39;</span><span class="p">]</span>

        <span class="n">solr_json</span><span class="p">[</span><span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">generic_json</span>
        <span class="k">return</span> <span class="n">solr_json</span></div>

    <span class="c1"># Dicionario de operadores.</span>
    <span class="c1"># Para operacoes com 1, 2 e 3 parametros.</span>
    <span class="n">dict_operators_1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is_empty&#39;</span><span class="p">:</span> <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">:[&quot;&quot; TO *]&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;is_not_empty&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:[&quot;&quot; TO *]&#39;</span><span class="p">,</span>
                        <span class="p">}</span>
    <span class="n">dict_operators_2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;equal&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;not_equal&#39;</span><span class="p">:</span> <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;less_or_equal&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:[* TO </span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;greater_or_equal&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:[</span><span class="si">%s</span><span class="s1"> TO *]&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;contains&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;not_contains&#39;</span><span class="p">:</span> <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="p">}</span>
    <span class="n">dict_operators_3</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;between&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:[</span><span class="si">%s</span><span class="s1"> TO </span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                        <span class="p">}</span></div>


<div class="viewcode-block" id="MultidimensionalTableView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.MultidimensionalTableView">[documentos]</a><span class="k">class</span> <span class="nc">MultidimensionalTableView</span><span class="p">(</span><span class="n">EntryPointView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multidimensional charts endpoint</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MultidimensionalTableView.json_response"><a class="viewcode-back" href="../../code/views.html#solr_front.views.MultidimensionalTableView.json_response">[documentos]</a>    <span class="k">def</span> <span class="nf">json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Sankey Chart</span>
        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;table_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pivot_table&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;pivot_table&#39;</span> <span class="ow">in</span> \
                                                              <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span>
                                                                  <span class="s1">&#39;omite_secoes&#39;</span><span class="p">]:</span>
            <span class="n">levels_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;json_levels_list&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">retorno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_content_pivot_table_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="n">levels_list</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">json_selected_facets</span><span class="p">)</span>
                <span class="n">solr_json</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;links&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">retorno</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;conf&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">retorno</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
                <span class="k">return</span> <span class="n">solr_json</span>
            <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                <span class="k">raise</span></div></div>


<div class="viewcode-block" id="MultidimensionalChartView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.MultidimensionalChartView">[documentos]</a><span class="k">class</span> <span class="nc">MultidimensionalChartView</span><span class="p">(</span><span class="n">EntryPointView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multidimensional charts endpoint.</span>
<span class="sd">    Bubble??</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MultidimensionalChartView.json_response"><a class="viewcode-back" href="../../code/views.html#solr_front.views.MultidimensionalChartView.json_response">[documentos]</a>    <span class="k">def</span> <span class="nf">json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Sankey Chart</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;chart_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sankey&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;sankey&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span>
            <span class="s1">&#39;omite_secoes&#39;</span><span class="p">]:</span>
            <span class="n">levels_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;json_levels_list&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">retorno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_content_sankey_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="n">levels_list</span><span class="p">,</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">json_selected_facets</span><span class="p">)</span>
                <span class="n">solr_json</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;links&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">retorno</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">retorno</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
                <span class="k">return</span> <span class="n">solr_json</span>
            <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="c1"># Bubble Chart</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;chart_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bubble&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;bubblechart&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span>
            <span class="s1">&#39;omite_secoes&#39;</span><span class="p">]:</span>
            <span class="n">levels_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;json_levels_list&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">retorno_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_content_bubble_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="n">levels_list</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">json_selected_facets</span><span class="p">)</span>
                <span class="n">retorno_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">retorno_list</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">retorno_list</span> <span class="k">if</span> <span class="n">retorno_list</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="c1"># Boxplot Chart</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;chart_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boxplot&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;boxplot&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span>
            <span class="s1">&#39;omite_secoes&#39;</span><span class="p">]:</span>
            <span class="n">levels_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;json_levels_list&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">retorno_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_content_boxplot_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="n">levels_list</span><span class="p">,</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">json_selected_facets</span><span class="p">)</span>
                <span class="n">retorno_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">retorno_list</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">retorno_list</span> <span class="k">if</span> <span class="n">retorno_list</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                <span class="k">raise</span></div></div>


<div class="viewcode-block" id="UnidimensionalChartView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.UnidimensionalChartView">[documentos]</a><span class="k">class</span> <span class="nc">UnidimensionalChartView</span><span class="p">(</span><span class="n">EntryPointView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; For a unique facet field query &quot;&quot;&quot;</span>

<div class="viewcode-block" id="UnidimensionalChartView.json_response"><a class="viewcode-back" href="../../code/views.html#solr_front.views.UnidimensionalChartView.json_response">[documentos]</a>    <span class="k">def</span> <span class="nf">json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;chart_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;wordcloud&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;wordcloud&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span>
            <span class="s1">&#39;omite_secoes&#39;</span><span class="p">]:</span>
            <span class="n">single_facet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;single_facet&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">retorno_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_content_wordcloud_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span>
                                                                                  <span class="n">single_facet</span><span class="p">,</span>
                                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">json_selected_facets</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">retorno_list</span> <span class="k">if</span> <span class="n">retorno_list</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                <span class="k">raise</span></div></div>


<div class="viewcode-block" id="SearchView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SearchView">[documentos]</a><span class="k">class</span> <span class="nc">SearchView</span><span class="p">(</span><span class="n">EntryPointView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ajax get_data chama essa view.</span>
<span class="sd">    Recebe os requests de busca aa partir do querybuilder e dos facets.</span>
<span class="sd">    O pai (EntryPointView) trata o request, recupera resultados no Solr e retorna para o frontend.</span>
<span class="sd">    Atualmente ela filtra o tipo de request, situacao, cx_pesquisa, json_facet.</span>
<span class="sd">    Fazer uma URL e uma view para cada.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SearchView.json_response"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SearchView.json_response">[documentos]</a>    <span class="k">def</span> <span class="nf">json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if vertice has children.</span>
<span class="sd">        If true, former query cant be changed. If parents is changed</span>
<span class="sd">        the state of the seach tree will be inconsistent.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Compare session and request query to verify if changed</span>
        <span class="n">query_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;body_json&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span>
        <span class="n">query_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span>
        <span class="n">dif_query</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">query_session</span><span class="p">,</span> <span class="n">query_request</span><span class="p">)</span>

        <span class="c1"># Compare session and request selected_facets to verify if changed</span>
        <span class="n">sf_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;body_json&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="s1">&#39;selected_facets_col1&#39;</span><span class="p">]</span>
        <span class="n">sf_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;selected_facets_col1&#39;</span><span class="p">]</span>
        <span class="n">dif_sf</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">sf_session</span><span class="p">,</span> <span class="n">sf_request</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dif_query</span> <span class="ow">or</span> <span class="n">dif_sf</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;p&gt;&lt;strong&gt;Atenção! &lt;/strong&gt;&lt;/p&gt;&lt;p&gt; Esta busca possui filhos (funil). &lt;br&gt;&#39;</span>
                               <span class="s1">&#39;Não é possível alterar a busca desta collection &#39;</span>
                               <span class="s1">&#39;porque isso tornaria a árvore de navegação inconsistente.&lt;/p&gt;&#39;</span>
                               <span class="s1">&#39;&lt;p&gt;Você pode continuar analisando os resultados desta busca. &lt;/p&gt;&#39;</span>
                               <span class="s1">&#39;&lt;p&gt;Caso você queira iniciar uma nova busca &#39;</span>
                               <span class="s1">&#39;ou alterar a estrutura da árvore de navegação, clique abaixo para iniciar nova navegação. &lt;br&gt; Ou clique no botão voltar para visualizar a busca atual. &lt;/p&gt;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">409</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">se</span> <span class="o">=</span> <span class="n">StreamingExpressions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;pedido&#39;</span><span class="p">]:</span>

            <span class="n">consulta</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">consulta</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">resultado</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">)</span>

                <span class="c1"># sucesso</span>
                <span class="k">if</span> <span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">consulta</span> <span class="o">=</span> <span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                <span class="c1"># falhou</span>
                <span class="k">elif</span> <span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Erro de indexação&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]}</span>
                <span class="c1"># em processo</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geraJson</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
            <span class="k">raise</span></div>

    <span class="sd">&quot;&quot;&quot;Retorna JSON do solr&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SearchView.get_solr_json"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SearchView.get_solr_json">[documentos]</a>    <span class="k">def</span> <span class="nf">get_solr_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Multilevel chart</span>
        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="k">if</span> <span class="s1">&#39;json_facet&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;json_facet&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">json_facet</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;json_facet&#39;</span><span class="p">])</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">solr_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_content_json_facet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="n">json_facet</span><span class="p">,</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">selected_facets</span><span class="p">[</span><span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Main request</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">solr_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_selected_facets</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_vertice</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">solr_json</span></div>

    <span class="sd">&quot;&quot;&quot; Função gera JSON modificado apartir do JSON retornado do solr &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SearchView.geraJson"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SearchView.geraJson">[documentos]</a>    <span class="k">def</span> <span class="nf">geraJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># API JSON FACET</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">solr_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solr_json</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="n">hierarquia</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;facets&#39;</span><span class="p">]:</span>
            <span class="c1"># if f != &#39;iden_Emp_incubada&#39;:</span>
            <span class="c1">#     continue</span>

            <span class="n">hierarquia</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># ignora item caso chave for count</span>

            <span class="k">if</span> <span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;facets&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;facets&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]:</span>
                    <span class="n">hierarquia</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
                    <span class="p">})</span>

        <span class="n">pivot_solr</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">monta_dict</span><span class="p">(</span><span class="n">elemento_pai</span><span class="p">,</span> <span class="n">chave</span><span class="p">,</span> <span class="n">elemento</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">group_by</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">elemento</span> <span class="ow">in</span> <span class="n">elemento_pai</span><span class="p">:</span>
                <span class="n">elemento_pai</span><span class="p">[</span><span class="n">elemento</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;chave&#39;</span><span class="p">:</span> <span class="n">chave</span><span class="p">,</span>
                    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">elemento</span><span class="p">,</span>
                    <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s2">&quot;groupBy&quot;</span><span class="p">:</span> <span class="n">group_by</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="n">elemento_pai</span><span class="p">[</span><span class="n">elemento</span><span class="p">][</span><span class="s1">&#39;facets&#39;</span><span class="p">]</span>

        <span class="c1"># Itera elementos da colection no dict do conf.py</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;FACETS&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;facetGroup&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;facets&#39;</span><span class="p">]:</span>
                    <span class="n">counter_facets</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">hierarquia</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hierarquia</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]]:</span>
                        <span class="k">continue</span>

                    <span class="c1"># if item[&#39;chave&#39;] != &#39;AREAS-DO-CONHECIMENTO-DE-ATUACAO_FACET&#39;:</span>
                    <span class="c1"># if item[&#39;chave&#39;] != &#39;LIVRE-DOCENCIA&#39;:</span>
                    <span class="c1">#    continue</span>

                    <span class="n">facet</span> <span class="o">=</span> <span class="n">hierarquia</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]]</span>
                    <span class="n">dict_inicial</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]:</span> <span class="p">{</span>
                        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;chave&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="p">{},</span>
                        <span class="s1">&#39;groupBy&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;groupBy&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">counter_facets</span><span class="p">,</span>
                        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span>
                    <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">for</span> <span class="n">idx_facet</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">facet</span><span class="p">):</span>
                        <span class="c1"># if not &#39;CIENCIAS_BIOLOGICAS|Química&#39; in value[&#39;value&#39;]:</span>
                        <span class="c1">#     continue</span>

                        <span class="n">dict_ref</span> <span class="o">=</span> <span class="n">dict_inicial</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]][</span><span class="s1">&#39;facets&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]):</span>
                            <span class="n">valores</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                            <span class="n">chave</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valores</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">chave</span> <span class="o">=</span> <span class="n">val</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">chave</span> <span class="o">+=</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">val</span>
                                <span class="n">dict_ref</span> <span class="o">=</span> <span class="n">monta_dict</span><span class="p">(</span><span class="n">dict_ref</span><span class="p">,</span> <span class="n">chave</span><span class="p">,</span> <span class="n">unicode</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;groupBy&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dict_inicial</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;chave&#39;</span><span class="p">]][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
                            <span class="n">chave</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                            <span class="n">monta_dict</span><span class="p">(</span><span class="n">dict_ref</span><span class="p">,</span> <span class="n">chave</span><span class="p">,</span> <span class="n">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]),</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;groupBy&#39;</span><span class="p">])</span>
                    <span class="n">pivot_solr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dict_inicial</span><span class="p">)</span>
                    <span class="n">counter_facets</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;facet_counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hierarquico&#39;</span><span class="p">:</span> <span class="n">pivot_solr</span><span class="p">}</span>

        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">solr_json</span></div>

    <span class="sd">&quot;&quot;&quot; função limpa numeros que vem no inciio do texto no padrão &#39;xx;texto&#39; retornando apenas texto &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SearchView.limpa_label"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SearchView.limpa_label">[documentos]</a>    <span class="k">def</span> <span class="nf">limpa_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="c1"># parents é usado para remover duplicatas no label quando repete o mesmo nome do facet pai</span>
        <span class="k">if</span> <span class="n">parents</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">parent</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">label</span> <span class="ow">and</span> <span class="n">label</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">label</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">label</span></div>

<div class="viewcode-block" id="SearchView.celery_check"><a class="viewcode-back" href="../../code/views.html#solr_front.views.SearchView.celery_check">[documentos]</a>    <span class="k">def</span> <span class="nf">celery_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertice</span><span class="p">):</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;pedido&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;hash_querybuilder&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot; Atualiza a data de indexacao da sub-collection &quot;&quot;&quot;</span>
            <span class="n">sub_collection</span> <span class="o">=</span> <span class="n">RelatedCollectionsCheck</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hash_querybuilder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;hash_querybuilder&#39;</span><span class="p">])</span>
            <span class="n">sub_collection</span><span class="o">.</span><span class="n">indexed_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">sub_collection</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">async_result</span> <span class="o">=</span> <span class="n">AsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">async_result</span><span class="o">.</span><span class="n">failed</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">async_result</span><span class="o">.</span><span class="n">traceback</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">async_result</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                <span class="c1"># Armazena modified_date no registro da collection relacionada.</span>
                <span class="c1"># self.solr_queries.update_indexed(hash_querybuilder)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">async_result</span><span class="o">.</span><span class="n">state</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">async_result</span><span class="o">.</span><span class="n">state</span><span class="p">}</span></div></div>


<div class="viewcode-block" id="RelatedCollection"><a class="viewcode-back" href="../../code/views.html#solr_front.views.RelatedCollection">[documentos]</a><span class="k">class</span> <span class="nc">RelatedCollection</span><span class="p">(</span><span class="n">EntryPointView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Captura os dados agregados de todas as collections relacionadas no grapho</span>
<span class="sd">    da collection principal</span>
<span class="sd">    Herda collection do EntryPoint e chama a classe StreamingExpressions, que acessa o</span>
<span class="sd">    conf.py com o Grapho e recupera os dados agregados do vertices relacionados.</span>
<span class="sd">    Essa View serve duas URLS. A primeira recupera os dados agregados de todas as</span>
<span class="sd">    collections do grapho, a segunda recupera somente da collection relacionada solicitada.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RelatedCollection.json_response"><a class="viewcode-back" href="../../code/views.html#solr_front.views.RelatedCollection.json_response">[documentos]</a>    <span class="k">def</span> <span class="nf">json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">top</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">se</span> <span class="o">=</span> <span class="n">StreamingExpressions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">get_join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_facets</span><span class="p">[</span><span class="s1">&#39;se_selected_facets&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">related_content</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Para cada vertice ligada a collection</span>
        <span class="k">for</span> <span class="n">vertice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">streaming_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">vertice</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">create_hash_querybuilder</span><span class="p">()</span>

            <span class="c1"># Executa SE para recuperar as qtds de cada collection relacionada (vertice)</span>
            <span class="c1"># Se nao houver registro no banco cria.</span>
            <span class="c1"># Se houver, verifica a data segunda uma regra no model e atualiza ou nao.</span>
            <span class="c1"># ! Isso eh soh para apresentar a quantidade de relacionados.</span>
            <span class="c1"># A verificacao da indexacao e indexacao da sub-collection eh feito</span>
            <span class="c1"># no AddVerticeView e na SearchView respectivamente.</span>
            <span class="n">related_collection_chk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_or_create_related_collection_db</span><span class="p">(</span><span class="n">vertice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">se</span><span class="p">)</span>

            <span class="n">count</span><span class="p">[</span><span class="n">vertice</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;col2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">related_collection_chk</span><span class="o">.</span><span class="n">qt_col2</span><span class="p">,</span>
                                       <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">EDGES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">vertice</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
                                       <span class="s1">&#39;parent_hash_querybuilder&#39;</span><span class="p">:</span> <span class="n">related_collection_chk</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">},</span>
                              <span class="s1">&#39;col1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">related_collection_chk</span><span class="o">.</span><span class="n">qt_col1</span><span class="p">}}</span>
            <span class="n">totalizadores</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="n">vertice</span><span class="p">][</span><span class="s1">&#39;OUTCOMES&#39;</span><span class="p">]</span>

            <span class="n">solr_json</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;unique&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;avg&#39;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">for</span> <span class="n">totalizador</span> <span class="ow">in</span> <span class="n">totalizadores</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;facet&#39;</span> <span class="ow">in</span> <span class="n">totalizador</span><span class="p">:</span>
                    <span class="n">selected_facets_col2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">facets2query</span><span class="p">(</span><span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;facet&#39;</span><span class="p">])</span>
                    <span class="n">sum_facets</span> <span class="o">=</span> <span class="n">selected_facets_col2</span><span class="p">[</span><span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_facets</span><span class="p">[</span><span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">]</span>
                    <span class="n">docs</span> <span class="o">=</span> <span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">]</span>
                    <span class="n">fq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">campo_dinamico_busca</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">related_collection_chk</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">totalizador_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_totalizador</span><span class="p">(</span><span class="n">vertice</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span>
                                                                             <span class="n">selected_facets_col2</span><span class="p">[</span><span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">],</span>
                                                                             <span class="n">docs</span><span class="p">)</span>
                        <span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;facet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consolida_totalizador</span><span class="p">(</span><span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;facet&#39;</span><span class="p">],</span> <span class="n">totalizador_dict</span><span class="p">,</span>
                                                                        <span class="n">totalizador</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                        <span class="k">raise</span>

            <span class="n">related_content</span><span class="p">[</span><span class="n">vertice</span><span class="p">]</span> <span class="o">=</span> <span class="n">solr_json</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_vertice</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span> <span class="n">top</span><span class="p">,</span> <span class="s1">&#39;related_content&#39;</span><span class="p">:</span> <span class="n">related_content</span><span class="p">}</span></div></div>

<div class="viewcode-block" id="currency"><a class="viewcode-back" href="../../code/views.html#solr_front.views.currency">[documentos]</a><span class="k">def</span> <span class="nf">currency</span><span class="p">(</span><span class="n">totalizador</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">totalizador</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span></div>



<div class="viewcode-block" id="TotalizadorView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.TotalizadorView">[documentos]</a><span class="k">class</span> <span class="nc">TotalizadorView</span><span class="p">(</span><span class="n">EntryPointView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recupera a collection para mostrar as respectivas totalizacoes.</span>
<span class="sd">    Essa view mostra apenas totalizacoes da propria collection. A totalizacao de relacionados</span>
<span class="sd">    eh recuperada na view RelatedCollection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TotalizadorView.check_data_type"><a class="viewcode-back" href="../../code/views.html#solr_front.views.TotalizadorView.check_data_type">[documentos]</a>    <span class="k">def</span> <span class="nf">check_data_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">totalizador</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get defined string as a data type and converts to the refered function</span>
<span class="sd">        defined here somewhere.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;data_type&#39;</span> <span class="ow">in</span> <span class="n">totalizador</span><span class="p">:</span>
            <span class="n">possibles</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">possibles</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
            <span class="n">function</span> <span class="o">=</span> <span class="n">possibles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;data_type&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">function</span></div>

<div class="viewcode-block" id="TotalizadorView.json_response"><a class="viewcode-back" href="../../code/views.html#solr_front.views.TotalizadorView.json_response">[documentos]</a>    <span class="k">def</span> <span class="nf">json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Os totalizadores tem entradas diferentes mas retornos iguais. Exemplo de retorno:</span>
<span class="sd">        {&#39;docs&#39;: [], &#39;numFound&#39;: 4260, &#39;order&#39;: 1, &#39;label&#39;: &#39;Aux\xc3\xadlios - Em andamento&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">totalizadores</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;OUTCOMES&#39;</span><span class="p">]</span>
        <span class="n">solr_json</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;unique&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;avg&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">totalizador</span> <span class="ow">in</span> <span class="n">totalizadores</span><span class="p">:</span>
            <span class="n">data_type_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_data_type</span><span class="p">(</span><span class="n">totalizador</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;facet&#39;</span> <span class="ow">in</span> <span class="n">totalizador</span><span class="p">:</span>
                <span class="n">selected_facets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">facets2query</span><span class="p">(</span><span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;facet&#39;</span><span class="p">])</span>
                <span class="n">sum_facets</span> <span class="o">=</span> <span class="n">selected_facets</span><span class="p">[</span><span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_facets</span><span class="p">[</span><span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">]</span>
                <span class="n">docs</span> <span class="o">=</span> <span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">totalizador_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_totalizador</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span> <span class="n">sum_facets</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                    <span class="k">raise</span>

                <span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;facet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consolida_totalizador</span><span class="p">(</span><span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;facet&#39;</span><span class="p">],</span> <span class="n">totalizador_dict</span><span class="p">,</span> <span class="n">totalizador</span><span class="p">)</span>

            <span class="k">elif</span> <span class="s1">&#39;sum&#39;</span> <span class="ow">in</span> <span class="n">totalizador</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_facets_json_api_sum</span><span class="p">(</span><span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">json_selected_facets</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                    <span class="k">raise</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">totalizador_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">totalizador_dict</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">sorlJsonQuery</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="s1">&#39;facets&#39;</span><span class="p">][</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                    <span class="k">raise</span>

                <span class="k">if</span> <span class="n">data_type_fn</span><span class="p">:</span>
                    <span class="n">totalizador_dict</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_type_fn</span><span class="p">(</span><span class="n">totalizador_dict</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">])</span>
                <span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consolida_totalizador</span><span class="p">(</span><span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">],</span> <span class="n">totalizador_dict</span><span class="p">,</span> <span class="n">totalizador</span><span class="p">)</span>


            <span class="k">elif</span> <span class="s1">&#39;unique&#39;</span> <span class="ow">in</span> <span class="n">totalizador</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">totalizador_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">totalizador_dict</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_facets_json_api_unique</span><span class="p">(</span><span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">],</span>
                                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span>
                                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">selected_facets</span><span class="p">[</span>
                                                                                                    <span class="s1">&#39;se_selected_facets&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                    <span class="k">raise</span>

                <span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consolida_totalizador</span><span class="p">(</span><span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">],</span> <span class="n">totalizador_dict</span><span class="p">,</span> <span class="n">totalizador</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;avg&#39;</span> <span class="ow">in</span> <span class="n">totalizador</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_facets_json_api_avg</span><span class="p">(</span><span class="n">totalizador</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fq</span><span class="p">,</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">json_selected_facets</span><span class="p">)</span>
                    <span class="n">totalizador_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">totalizador_dict</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">sorlJsonQuery</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="s1">&#39;facets&#39;</span><span class="p">][</span><span class="s1">&#39;avg&#39;</span><span class="p">]</span>
                    <span class="n">totalizador_dict</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalizador_dict</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                    <span class="k">raise</span>

                <span class="k">if</span> <span class="n">data_type_fn</span><span class="p">:</span>
                    <span class="n">totalizador_dict</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_type_fn</span><span class="p">(</span><span class="n">totalizador_dict</span><span class="p">[</span><span class="s1">&#39;numFound&#39;</span><span class="p">])</span>
                <span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consolida_totalizador</span><span class="p">(</span><span class="n">solr_json</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">totalizador_dict</span><span class="p">,</span> <span class="n">totalizador</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">solr_json</span></div></div>


<span class="c1">##################</span>
<span class="c1">### CreateView ###</span>
<span class="c1">##################</span>

<div class="viewcode-block" id="AddVerticeView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AddVerticeView">[documentos]</a><span class="k">class</span> <span class="nc">AddVerticeView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recebe a collection de destino e um hash_querybuilder.</span>
<span class="sd">    Instancia um objeto da classe StreamingExpressions para indexar essa collection</span>
<span class="sd">    de destino com os dados do hash_querybuilder.</span>
<span class="sd">    Ao final, redireciona o usuario para busca na collection de destino.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;base_sf.html&#39;</span>

<div class="viewcode-block" id="AddVerticeView.dispatch"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AddVerticeView.dispatch">[documentos]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;template&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="o">=</span> <span class="n">find_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span> <span class="o">=</span> <span class="n">SolrQueries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">se</span> <span class="o">=</span> <span class="n">StreamingExpressions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AddVerticeView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AddVerticeView.get"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AddVerticeView.get">[documentos]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="k">if</span> <span class="s1">&#39;collection_destino&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_sf</span><span class="o">.</span><span class="n">USE_CELERY</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Celery not found. You have to have Celery installed to use this feature.&#39;</span><span class="p">,</span>
                                    <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>

            <span class="sd">&quot;&quot;&quot; Se for funil, pega vertice pai e adiciona um vertice filho &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span> <span class="o">=</span> <span class="n">NavigateCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection_destino&#39;</span><span class="p">])</span>
            <span class="n">parent_vertice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">get_vertice</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="n">parent_fq</span> <span class="o">=</span> <span class="n">parent_vertice</span><span class="p">[</span><span class="s1">&#39;fq&#39;</span><span class="p">]</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Para indexar somente os documentos que ainda nao foram indexados, para o respectivo campo dinamico</span>
<span class="sd">            O campo dinamico identifica todos os relacionados de uma collection a outra.</span>
<span class="sd">            Como a base muda, os documentos que nao foram indexados precisam ser. E nao indexa tudo sempre pq eh</span>
<span class="sd">            muito custoso.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># 1 - Primeiro recupera a Streaming Expression</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">get_join</span><span class="p">(</span><span class="n">parent_fq</span><span class="p">,</span> <span class="n">parent_vertice</span><span class="p">[</span><span class="s1">&#39;selected_facets_col1&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection_destino&#39;</span><span class="p">]]</span>

            <span class="c1"># 2 - Configura instancia do solr_queries para pegar o hash_querybuilder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">streaming_expression</span> <span class="o">=</span> <span class="n">se</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">create_hash_querybuilder</span><span class="p">()</span>

            <span class="c1"># 3 - Depios gera a Streaming Expression excluindo os documentos que jah estao num_indexados</span>
            <span class="c1"># com o respectivo campo.</span>
            <span class="n">exclui_campo_dinamico_busca</span> <span class="o">=</span> <span class="s1">&#39;fq=-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">campo_dinamico_busca</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">get_join</span><span class="p">(</span><span class="n">parent_fq</span><span class="p">,</span> <span class="n">parent_vertice</span><span class="p">[</span><span class="s1">&#39;selected_facets_col1&#39;</span><span class="p">],</span> <span class="n">exclui_campo_dinamico_busca</span><span class="p">)</span>
            <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">hash_join</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection_destino&#39;</span><span class="p">]]</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Sempre (re)indexa a sub-collection. Se na primeira indexacao da sub-collection</span>
<span class="sd">            nao indexou tudo, por algum problema no Celery, na proxima indexa somente o que faltou.</span>
<span class="sd">            Essa eh uma caracteristica da funcao de indexacao. Ver o do_reindex.</span>
<span class="sd">            Se necessario, eh possivel indexar somente uma vez, mas corre-se o risco de</span>
<span class="sd">            nao indexar tudo e faltarem registros na sub-collection</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">do_reindex</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection_destino&#39;</span><span class="p">])</span>
            <span class="n">pedido</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pedido</span> <span class="o">=</span> <span class="nb">id</span><span class="o">.</span><span class="n">id</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">add_vertice</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection_destino&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span> <span class="p">{</span>
                <span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">campo_dinamico_busca</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">]}},</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pedido</span><span class="p">)</span>

            <span class="c1"># import pdb; pdb.set_trace()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection_destino&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot; Se for uma nova navegacao, inicializa objeto navigation na sessao &quot;&quot;&quot;</span>
            <span class="c1"># A busca inicial fica na sessao. Os joins de collections ficam em banco.</span>
            <span class="n">initial_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">get_search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span> <span class="o">=</span> <span class="n">NavigateCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">add_vertice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;qs_selected_facets&#39;</span><span class="p">:</span> <span class="p">{}},</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">hash_querybuilder</span><span class="p">,</span> <span class="n">initial_search</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">))</span></div>

<div class="viewcode-block" id="AddVerticeView.get_success_url"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AddVerticeView.get_success_url">[documentos]</a>    <span class="k">def</span> <span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;params_id&#39;</span><span class="p">,</span>
                           <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="n">collection</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">],</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GenericLoggerException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span></div></div>


<span class="c1">####################</span>
<span class="c1">### TemplateView ###</span>
<span class="c1">####################</span>

<div class="viewcode-block" id="HomeBuscador"><a class="viewcode-back" href="../../code/views.html#solr_front.views.HomeBuscador">[documentos]</a><span class="k">class</span> <span class="nc">HomeBuscador</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">TemplateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Home inicial do buscador, que sempre verifica se jah tem pesquisa na sessao.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HomeBuscador.get"><a class="viewcode-back" href="../../code/views.html#solr_front.views.HomeBuscador.get">[documentos]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">erro</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;navigation&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">erro</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;titulo&#39;</span><span class="p">:</span> <span class="s1">&#39;Já existe uma pesquisa em andamento&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;descricao&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;home_sf.html&#39;</span>
        <span class="c1"># pega collections disponiveis</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="n">sfs_object</span><span class="o">.</span><span class="n">get_collections_meta</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;template&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">template_name</span> <span class="o">=</span> <span class="n">find_template</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="n">erro</span><span class="p">,</span> <span class="s1">&#39;collections&#39;</span><span class="p">:</span> <span class="n">collections</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span>
                <span class="s1">&#39;template&#39;</span><span class="p">]})</span>  <span class="c1"># , context_instance=RequestContext(self.request))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GenericLoggerException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="HomeCollection"><a class="viewcode-back" href="../../code/views.html#solr_front.views.HomeCollection">[documentos]</a><span class="k">class</span> <span class="nc">HomeCollection</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">TemplateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Home page da collection.</span>
<span class="sd">    Para informacoes a respeito da collection na visao da collection no Grapho,</span>
<span class="sd">    nao da instancia de uma busca.</span>
<span class="sd">    Utilizar por exemplo como pagina de ajuda, como ela se relaciona com outras</span>
<span class="sd">    collectios etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="HomeCollection.get"><a class="viewcode-back" href="../../code/views.html#solr_front.views.HomeCollection.get">[documentos]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;home_collection.html&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;template&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">template_name</span> <span class="o">=</span> <span class="n">find_template</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">],</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span>
                <span class="s1">&#39;template&#39;</span><span class="p">]})</span>  <span class="c1"># , context_instance=RequestContext(request))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GenericLoggerException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="AutoComplete"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AutoComplete">[documentos]</a><span class="k">class</span> <span class="nc">AutoComplete</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<div class="viewcode-block" id="AutoComplete.post"><a class="viewcode-back" href="../../code/views.html#solr_front.views.AutoComplete.post">[documentos]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span> <span class="o">=</span> <span class="n">SolrQueries</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">autocomplete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">get_facet_4_autocomplete</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">selected_facets</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;selected_facets&#39;</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">autocomplete</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ParamsView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ParamsView">[documentos]</a><span class="k">class</span> <span class="nc">ParamsView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">TemplateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Carrega a pagina inicial da pesquisa de uma determinada collection &quot;&quot;&quot;</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;base_sf.html&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ParamsView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ParamsView.dispatch"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ParamsView.dispatch">[documentos]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recebe uma collectino e respectivo id.</span>
<span class="sd">        Caso não exista este vertice na pesquisa (objeto navigation da sessao), cria.</span>
<span class="sd">        Se existir, retorna pagina desse vertice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Trying access to a not known collection.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s2">&quot;Collection does not exist&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;template&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="o">=</span> <span class="n">find_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span> <span class="o">=</span> <span class="n">NavigateCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">get_vertice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;start_research&#39;</span><span class="p">,</span>
                                        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]}),</span>
                                <span class="n">permanent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GenericLoggerException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;home_sf&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]}),</span> <span class="n">permanent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GenericLoggerException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ParamsView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParamsView.get_context_data"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ParamsView.get_context_data">[documentos]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ParamsView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;id_collection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;vertice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">)</span>  <span class="c1"># , ensure_ascii=False ).encode(&#39;utf8&#39;)</span>
        <span class="k">if</span> <span class="s1">&#39;QUERY_BUILDER&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;querybuilder_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;QUERY_BUILDER&#39;</span><span class="p">])</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;facets_categorias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;FACETS&#39;</span><span class="p">])</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;collection_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;totalizadores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;OUTCOMES&#39;</span><span class="p">])</span>  <span class="c1"># , ensure_ascii=False ).encode(&#39;utf8&#39;)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;totalizadores_rel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_totalizadores_rel</span><span class="p">())</span>  <span class="c1"># , ensure_ascii=False ).encode(&#39;utf8&#39;)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;home_sf_rurl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;home_sf&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]})</span>

        <span class="c1"># context[&#39;omite_secoes&#39;] = COLLECTIONS[self.collection][&#39;COLLECTION&#39;][&#39;omite_secoes&#39;]</span>
        <span class="c1"># context[&#39;documentos&#39;] =   json.dumps(COLLECTIONS[self.collection][&#39;COLLECTION&#39;][&#39;documentos&#39;], ensure_ascii=False ).encode(&#39;utf8&#39;)</span>
        <span class="c1"># context[&#39;vertice&#39;] = json.dumps(self.vertice, ensure_ascii=False ).encode(&#39;utf8&#39;)</span>
        <span class="c1"># context[&#39;totalizadores&#39;] = json.dumps(COLLECTIONS[self.collection][&#39;COLLECTION&#39;][&#39;totalizadores&#39;], ensure_ascii=False ).encode(&#39;utf8&#39;)</span>
        <span class="c1"># context[&#39;totalizadores_rel&#39;] = json.dumps(self.get_totalizadores_rel(), ensure_ascii=False ).encode(&#39;utf8&#39;)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;omite_secoes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;COLLECTION&#39;</span><span class="p">][</span><span class="s1">&#39;omite_secoes&#39;</span><span class="p">],</span>
                                                 <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;omite_secoes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;multilevel_barchart_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;MULTILEVEL_BARCHART_1&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span> <span class="ow">and</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span>
            <span class="s1">&#39;MULTILEVEL_BARCHART_1&#39;</span><span class="p">]:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;multilevel_barchart_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;MULTILEVEL_BARCHART_1&#39;</span><span class="p">]</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sankey_chart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;SANKEY_CHART&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span> <span class="ow">and</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;SANKEY_CHART&#39;</span><span class="p">]:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sankey_chart_json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;SANKEY_CHART&#39;</span><span class="p">])</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sankey_chart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;SANKEY_CHART&#39;</span><span class="p">]</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;pivot_table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;PIVOT_TABLE&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span> <span class="ow">and</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;PIVOT_TABLE&#39;</span><span class="p">]:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;pivot_table_json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;PIVOT_TABLE&#39;</span><span class="p">])</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;pivot_table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;PIVOT_TABLE&#39;</span><span class="p">]</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;bubble_chart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;BUBBLE_CHART&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span> <span class="ow">and</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;BUBBLE_CHART&#39;</span><span class="p">]:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;bubble_chart_json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;BUBBLE_CHART&#39;</span><span class="p">])</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;bubble_chart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;BUBBLE_CHART&#39;</span><span class="p">]</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;wordcloud&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;WORDCLOUD_CHART&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span> <span class="ow">and</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;WORDCLOUD_CHART&#39;</span><span class="p">]:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;wordcloud_chart_json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;WORDCLOUD_CHART&#39;</span><span class="p">])</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;wordcloud_chart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;WORDCLOUD_CHART&#39;</span><span class="p">]</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;boxplot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;BOXPLOT_CHART&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span> <span class="ow">and</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;BOXPLOT_CHART&#39;</span><span class="p">]:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;boxplot_chart_json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;BOXPLOT_CHART&#39;</span><span class="p">])</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;boxplot_chart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">][</span><span class="s1">&#39;BOXPLOT_CHART&#39;</span><span class="p">]</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;form_csv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExportForm</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GRAPH</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="ParamsView.get_totalizadores_rel"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ParamsView.get_totalizadores_rel">[documentos]</a>    <span class="k">def</span> <span class="nf">get_totalizadores_rel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recupera os totalizadores das collections relacionadas &quot;&quot;&quot;</span>
        <span class="n">totalizadores_rel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">GRAPH</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">]:</span>
            <span class="n">totalizadores_rel</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">edge</span><span class="p">:</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s1">&#39;OUTCOMES&#39;</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">totalizadores_rel</span></div></div>


<div class="viewcode-block" id="CleanSession"><a class="viewcode-back" href="../../code/views.html#solr_front.views.CleanSession">[documentos]</a><span class="k">class</span> <span class="nc">CleanSession</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Limpa a sessao do usuario &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CleanSession.get"><a class="viewcode-back" href="../../code/views.html#solr_front.views.CleanSession.get">[documentos]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span> <span class="o">=</span> <span class="n">NavigateCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">remove_vertice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
        <span class="n">erro</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;home_sf&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]}),</span> <span class="n">permanent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GenericLoggerException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="ExportDataView"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ExportDataView">[documentos]</a><span class="k">class</span> <span class="nc">ExportDataView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create Report</span>
<span class="sd">    If no join is required due to search on the first level only,</span>
<span class="sd">    session object has the search query to get data and export.</span>
<span class="sd">    If data requested to export comes from a joint search, it is necessary</span>
<span class="sd">    to get de join query from database in order to export data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExportDataView.dispatch"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ExportDataView.dispatch">[documentos]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span> <span class="o">=</span> <span class="n">NavigateCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">get_vertice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span> <span class="o">=</span> <span class="n">SolrQueries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ExportDataView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExportDataView.get"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ExportDataView.get">[documentos]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">]:</span>
            <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;initial_search&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">navigation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navigate</span><span class="o">.</span><span class="n">get_navigation_tree</span><span class="p">()</span>
            <span class="c1"># Recupera o id do hash_join para pegar no db o hash_join</span>
            <span class="c1"># Com essa streaming expression eh possivel recuperar os dados no Solr.</span>
            <span class="n">hash_querybuilder</span> <span class="o">=</span> <span class="n">navigation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;hash_querybuilder&quot;</span><span class="p">]</span>
            <span class="n">se</span> <span class="o">=</span> <span class="n">RelatedCollectionsCheck</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hash_querybuilder</span><span class="o">=</span><span class="n">hash_querybuilder</span><span class="p">)</span><span class="o">.</span><span class="n">join</span>

        <span class="c1"># recria form apartir do request</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ExportForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">makeDataFrame</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email_from&#39;</span><span class="p">],</span>
                               <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email_to&#39;</span><span class="p">],</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;comentario&#39;</span><span class="p">],</span>
                               <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;formato&#39;</span><span class="p">])</span>

            <span class="c1"># Return information about the status of report</span>
            <span class="c1"># User will receive e-mail with link to download the report.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Seu pedido está em processamento e será enviado por e-mail.&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;erro&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExportDataView.dict_values_to_string"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ExportDataView.dict_values_to_string">[documentos]</a>    <span class="k">def</span> <span class="nf">dict_values_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">final_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; ,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_values_to_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">final_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dados</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">final_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dados</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                                <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">valor</span> <span class="o">=</span> <span class="s1">&#39; ,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valor</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                                <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">valor</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">valor</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_values_to_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                            <span class="n">final_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parametro data não é um dict ou lista de dicts&quot;</span><span class="p">)</span>

                <span class="n">final_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;else&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parametro data não é um dict ou lista de dicts&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">final_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">final_list</span>
        <span class="k">elif</span> <span class="n">final_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">final_dict</span></div>

<div class="viewcode-block" id="ExportDataView.makeDataFrame"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ExportDataView.makeDataFrame">[documentos]</a>    <span class="k">def</span> <span class="nf">makeDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">nome</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">para</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">formato</span><span class="p">):</span>

        <span class="k">if</span> <span class="s1">&#39;export_fields&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;EXPORT_DATA&#39;</span><span class="p">]:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;EXPORT_DATA&#39;</span><span class="p">][</span><span class="s1">&#39;export_fields&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;export_sort_by&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;EXPORT_DATA&#39;</span><span class="p">]:</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;EXPORT_DATA&#39;</span><span class="p">][</span><span class="s1">&#39;export_sort_by&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
                       <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;EXPORT_DATA&#39;</span><span class="p">][</span><span class="s1">&#39;export_sort_op&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; asc&#39;</span>

            <span class="n">se</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, sort=&quot;id asc&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;, sort=&quot;&#39;</span> <span class="o">+</span> <span class="n">sort</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">se</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;fl=&quot;id&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;fl=&quot;&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;max_rows&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;EXPORT_DATA&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">executaStreamingExpression</span><span class="p">(</span><span class="n">se</span><span class="p">)[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">][</span>
                                <span class="p">:</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;EXPORT_DATA&#39;</span><span class="p">][</span><span class="s1">&#39;max_rows&#39;</span><span class="p">]]</span>
                <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">executaStreamingExpression</span><span class="p">(</span><span class="n">se</span><span class="p">)[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span>

            <span class="n">data_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_values_to_string</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

            <span class="c1"># converte para dataframe</span>
            <span class="k">if</span> <span class="n">settings_sf</span><span class="o">.</span><span class="n">USE_CELERY</span><span class="p">:</span>
                <span class="n">makeData_celery</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">nome</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">para</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">formato</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Celery not found. You have to have Celery installed  to use this feature.&#39;</span><span class="p">,</span>
                                    <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
                <span class="c1"># makeData_celery(data_list, nome, email, para, msg, fields, formato)</span>

            <span class="k">return</span> <span class="n">data_list</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;export_fields nao foi definido na configuracao desta collection&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExportDataView.makeCsv"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ExportDataView.makeCsv">[documentos]</a>    <span class="k">def</span> <span class="nf">makeCsv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">nome</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">para</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">executaStreamingExpression</span><span class="p">(</span><span class="n">se</span><span class="p">)[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">settings_sf</span><span class="o">.</span><span class="n">USE_CELERY</span><span class="p">:</span>
            <span class="n">makeCsv_celery</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">nome</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">para</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Celery not found. You have to have Celery installed to use this feature.&#39;</span><span class="p">,</span>
                                <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
            <span class="c1"># makeCsv_celery(data_list, nome, email, para, msg)</span>

        <span class="k">if</span> <span class="s1">&#39;export_fields&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]]:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;export_fields&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;export_sort_by&#39;</span> <span class="ow">in</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]]:</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="n">COLLECTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertice</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]][</span><span class="s1">&#39;export_sort_by&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; asc&#39;</span>

            <span class="n">se</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, sort=&quot;id asc&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;, sort=&quot;&#39;</span> <span class="o">+</span> <span class="n">sort</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">se</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;fl=&quot;id&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;fl=&quot;&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limite_itens_export</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">executaStreamingExpression</span><span class="p">(</span><span class="n">se</span><span class="p">)[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">][</span>
                                <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">limite_itens_export</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_queries</span><span class="o">.</span><span class="n">executaStreamingExpression</span><span class="p">(</span><span class="n">se</span><span class="p">)[</span><span class="s1">&#39;result-set&#39;</span><span class="p">][</span><span class="s1">&#39;docs&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">GetSolarDataException</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span>

            <span class="n">data_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_values_to_string</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">settings_sf</span><span class="o">.</span><span class="n">USE_CELERY</span><span class="p">:</span>
                <span class="n">makeCsv_celery</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">nome</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">para</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Celery not found. You have to have Celery installed to have this feature.&#39;</span><span class="p">,</span>
                                    <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;export_fields nao foi definido na configuracao desta collection&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExportDataView.pos_process"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ExportDataView.pos_process">[documentos]</a>    <span class="k">def</span> <span class="nf">pos_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">list_fields_extraction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Metodo utiliza configuração do fields_extraction para extrair valores de data e tratalos com a função especificada&quot;&quot;&quot;</span>
        <span class="n">final_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dict_fields_extraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_tuple_to_dict</span><span class="p">(</span><span class="n">list_fields_extraction</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">item_data</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

                <span class="c1"># se existir no lista de tratamento trata</span>
                <span class="c1"># valor usando função especificada, caso não retorna valor original</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fields_extraction</span><span class="p">:</span>
                    <span class="n">method_to_call</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">extractors</span><span class="p">,</span> <span class="n">dict_fields_extraction</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="n">item_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">method_to_call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">final_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_data</span></div>

<div class="viewcode-block" id="ExportDataView.list_tuple_to_dict"><a class="viewcode-back" href="../../code/views.html#solr_front.views.ExportDataView.list_tuple_to_dict">[documentos]</a>    <span class="k">def</span> <span class="nf">list_tuple_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_tuple</span><span class="p">):</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">list_tuple</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="nb">dict</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>